<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProTactix — Cleaner Tactics Console</title>
  <style>
    :root{
      --bg-0:#071426;
      --bg-1:#0a2a3d;
      --panel:#0d2636;
      --accent:#1282a2;
      --accent-2:#ffd166;
      --danger:#e63946;
      --muted:#9fc7d3;
      --text:#ecf6f8;
      --glass:rgba(255,255,255,0.03);
      --shadow:0 12px 40px rgba(0,0,0,0.6);
      --radius:12px;
      --transition:200ms cubic-bezier(.2,.9,.3,1);
    }

    /* reset */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:var(--text);background:linear-gradient(180deg,var(--bg-0),var(--bg-1));-webkit-font-smoothing:antialiased}

    /* layout */
    .app{
      display:grid;
      grid-template-columns:280px 1fr 320px;
      grid-template-rows:72px 1fr;
      gap:18px;
      height:100vh;
      padding:16px;
    }

    header.topbar{
      grid-column:1/-1;
      display:flex;
      align-items:center;
      gap:18px;
      padding:12px 18px;
      background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,0.03);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#0a6b77);
      display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;font-family:Oswald,Segoe UI,sans-serif
    }
    .title{font-weight:700;font-size:16px;color:var(--accent-2)}
    .subtitle{font-size:12px;color:var(--muted)}

    .toolbar{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn{background:linear-gradient(180deg,#0f3a47,#09252f);border:1px solid rgba(255,255,255,0.03);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;transition:var(--transition);font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#0f9fb0);box-shadow:0 8px 30px rgba(18,130,162,0.12)}
    .btn.warn{background:linear-gradient(90deg,#e07a5f,#d4503a)}

    /* left panel */
    aside.left{
      background:var(--panel);border-radius:var(--radius);padding:16px;border:1px solid rgba(255,255,255,0.02);box-shadow:var(--shadow);overflow:auto;
    }
    .sectionTitle{font-weight:700;color:var(--text);margin-bottom:8px}
    .muted{color:var(--muted);font-size:13px}

    .controls{display:flex;flex-direction:column;gap:12px}

    .modes{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 10px;background:var(--glass);border-radius:8px;border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .chip.active{background:linear-gradient(90deg,var(--accent),#0f9fb0);color:#062428;font-weight:700}

    .control{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}

    label.small{display:block;color:var(--muted);font-size:12px;margin-bottom:8px}

    input[type="range"]{width:100%}

    /* center pitch */
    .center{display:flex;align-items:center;justify-content:center;padding:6px}
    .pitchCard{width:100%;max-width:1200px;height:calc(100vh - 160px);border-radius:12px;background:linear-gradient(180deg,#1a7a3d,#0b4b22);box-shadow:0 20px 60px rgba(0,0,0,0.6);position:relative;border:6px solid rgba(255,255,255,0.02);overflow:hidden;transform-origin:center center}
    svg#pitchSVG{width:100%;height:100%;display:block}

    /* player DOM */
    #playerLayer{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
    .player{
      position:absolute;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;user-select:none;touch-action:none;cursor:grab;transform:translate(-50%,-50%);box-shadow:0 14px 30px rgba(0,0,0,0.5);pointer-events:auto;transition:transform 150ms,var(--transition)
    }
    .player.home{background:linear-gradient(180deg,#ffffff,#eef6f6);color:#042022;border:4px solid var(--accent)}
    .player.away{background:linear-gradient(180deg,#0b1220,#0f1726);color:#fff;border:4px solid #ffffff33}
    .player.ball{width:36px;height:36px;border-radius:50%;background:#fff;color:#022b2f;border:3px solid #0b1220;font-weight:900;font-size:12px}
    .player.selected{transform:translate(-50%,-50%) scale(1.08);box-shadow:0 24px 48px rgba(0,0,0,0.6), 0 0 0 6px rgba(18,130,162,0.08)}

    /* arrows */
    .arrowLine{stroke:#fff;stroke-width:3;stroke-linecap:round;opacity:0.95;fill:none}
    .arrowHead{fill:#fff}
    .arrowGlow{filter:url(#glow);stroke-linecap:round}

    /* right panel */
    aside.right{background:var(--panel);border-radius:var(--radius);padding:16px;border:1px solid rgba(255,255,255,0.02);box-shadow:var(--shadow);overflow:auto}
    .panelItem{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;margin-bottom:12px}
    .kbd{background:#062428;padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);color:var(--muted);font-size:12px}

    /* timeline */
    .timeline{position:absolute;left:16px;right:16px;bottom:16px;background:rgba(0,0,0,0.28);padding:10px;border-radius:10px;display:flex;gap:10px;align-items:center;border:1px solid rgba(255,255,255,0.03)}
    .progress{height:8px;background:linear-gradient(90deg,var(--accent),#0f9fb0);border-radius:6px;width:0%}

    /* tooltips & helpers */
    .hint{font-size:13px;color:var(--muted)}
    .flexRow{display:flex;gap:10px;align-items:center}
    .spacer{flex:1}

    /* responsive */
    @media(max-width:1100px){
      .app{grid-template-columns:1fr;grid-template-rows:72px auto auto}
      aside.left,aside.right{order:2}
      .center{order:1;padding:10px}
      .pitchCard{height:60vh}
    }

  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo">PT</div>
        <div>
          <div class="title">ProTactix</div>
          <div class="subtitle">Cleaner • directional • user-friendly</div>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn ghost" id="btnUndo">Undo</button>
        <button class="btn ghost" id="btnRedo">Redo</button>
        <button class="btn" id="btnImport">Import</button>
        <button class="btn primary" id="btnExport">Export</button>
      </div>
    </header>

    <!-- LEFT -->
    <aside class="left">
      <div class="sectionTitle">Tools</div>
      <div class="muted">Choose a mode to interact with the pitch</div>

      <div class="controls" style="margin-top:12px">
        <div class="control">
          <label class="small">Mode</label>
          <div class="modes">
            <div class="chip active" data-mode="select">Select (S)</div>
            <div class="chip" data-mode="draw">Draw (D)</div>
            <div class="chip" data-mode="curve">Curve (C)</div>
            <div class="chip" data-mode="erase">Erase (E)</div>
          </div>
          <div class="hint" style="margin-top:8px">Click a player to start, then drag to draw an arrow. For curve mode, drag control point to shape the run.</div>
        </div>

        <div class="control">
          <label class="small">Add entity</label>
          <div style="display:flex;gap:8px">
            <button class="btn" id="addHome">Add Home</button>
            <button class="btn" id="addAway">Add Away</button>
            <button class="btn" id="addBall">Add Ball</button>
          </div>
        </div>

        <div class="control">
          <label class="small">Arrow style</label>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <select id="arrowStyle" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
              <option value="solid">Solid</option>
              <option value="dashed">Dashed</option>
              <option value="curved">Curved auto</option>
              <option value="glow">Glow (fast)</option>
            </select>
            <input id="arrowWidth" type="number" min="1" max="12" value="3" style="width:72px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
          </div>
          <div style="display:flex;gap:8px">
            <input id="arrowColor" type="color" value="#ffd166" style="width:52px;height:36px;border-radius:8px;border:0;cursor:pointer">
            <div class="muted" style="align-self:center">Color</div>
          </div>
        </div>

        <div class="control">
          <label class="small">View</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="zoomRange" type="range" min="0.6" max="1.6" step="0.05" value="1" />
            <div class="muted" id="zoomLabel">100%</div>
          </div>
          <label class="small" style="margin-top:10px"><input id="snapGrid" type="checkbox"> Snap to grid</label>
        </div>

      </div>
    </aside>

    <!-- CENTER -->
    <div class="center">
      <div class="pitchCard" id="pitchCard" tabindex="0" aria-label="Tactics pitch">
        <svg id="pitchSVG" viewBox="0 0 1100 700" preserveAspectRatio="xMidYMid meet">
          <defs>
            <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="6" result="coloredBlur"></feGaussianBlur>
              <feMerge>
                <feMergeNode in="coloredBlur"></feMergeNode>
                <feMergeNode in="SourceGraphic"></feMergeNode>
              </feMerge>
            </filter>
            <marker id="arrowHead" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto" markerUnits="strokeWidth">
              <path class="arrowHead" d="M0,0 L12,6 L0,12 z" fill="#fff" />
            </marker>
            <marker id="arrowHeadGlow" markerWidth="20" markerHeight="20" refX="16" refY="10" orient="auto">
              <path d="M0,0 L20,10 L0,20 z" fill="#fff" opacity="0.95"/>
            </marker>
            <pattern id="grass" patternUnits="userSpaceOnUse" width="110" height="700">
              <rect width="110" height="700" fill="#1f7a39"></rect>
              <rect width="55" height="700" fill="#176a2f"></rect>
            </pattern>
          </defs>

          <rect x="0" y="0" width="1100" height="700" fill="url(#grass)"></rect>

          <!-- pitch lines -->
          <g id="pitchLines" stroke="#ffffff" stroke-opacity="0.75" fill="none" stroke-width="3">
            <rect x="60" y="30" width="980" height="640" rx="10" stroke-opacity="0.6" />
            <circle cx="550" cy="365" r="70" stroke-opacity="0.45" />
            <line x1="550" y1="30" x2="550" y2="670" stroke-opacity="0.45" />
            <rect x="60" y="150" width="180" height="220" rx="6" stroke-opacity="0.45"></rect>
            <rect x="860" y="150" width="180" height="220" rx="6" stroke-opacity="0.45"></rect>
          </g>

          <!-- arrows + temp -->
          <g id="arrowsLayer"></g>
          <g id="tempLayer"></g>
        </svg>

        <!-- players as DOM (easier to drag / animate) -->
        <div id="playerLayer"></div>

        <!-- timeline (simple) -->
        <div class="timeline" role="region" aria-label="Replay timeline">
          <button class="btn ghost" id="playPause">Play</button>
          <div class="spacer"></div>
          <div style="flex:1;max-width:560px;background:rgba(255,255,255,0.03);height:8px;border-radius:6px;overflow:hidden">
            <div class="progress" id="playProgress" style="width:0%"></div>
          </div>
          <div class="spacer"></div>
          <div class="muted" id="frameLabel">Frame: 0</div>
        </div>

      </div>
    </div>

    <!-- RIGHT -->
    <aside class="right">
      <div class="panelItem">
        <div class="sectionTitle">Selection</div>
        <div class="muted" id="selInfo">Type: — <br> Team: — <br> Label: —</div>
      </div>

      <div class="panelItem">
        <div class="sectionTitle">Export / Import</div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="btnExportJSON">Download JSON</button>
          <button class="btn" id="btnLoadJSON">Load JSON</button>
          <input type="file" id="fileInput" accept=".json" style="display:none">
        </div>
      </div>

      <div class="panelItem">
        <div class="sectionTitle">Quick Actions</div>
        <div style="display:flex;gap:8px">
          <button class="btn warn" id="btnClear">Clear Pitch</button>
          <button class="btn" id="btnReset">Reset View</button>
        </div>
      </div>

      <div class="panelItem">
        <div class="sectionTitle">Shortcuts</div>
        <div class="muted">S - Select • D - Draw • C - Curve • E - Erase • DEL - Delete • Z / Y - Undo/Redo</div>
      </div>
    </aside>
  </div>

  <script>
    /* Cleaned up JS — clearer separation of concerns, direction-first UX */

    /* Utilities */
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
    const uid = (p = '') => p + Math.random().toString(36).slice(2,9);
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const VB = {w:1100, h:700}; // viewBox for svg pitch

    /* State */
    const App = {
      mode: 'select', // select|draw|curve|erase
      players: [], // {uid,type,xPct,yPct,label,z}
      arrows: [],   // {id,fromUid,toUid,x1,y1,x2,y2,style,width,color,control}
      drawing: null, // {fromUid, start:{x,y}, cur:{x,y}, tempElem}
      undoStack: [], redoStack: [],
      frames: [], playing: false, currentFrame: 0
    };

    /* Elements */
    const pitchCard = $('#pitchCard');
    const pitchSVG = $('#pitchSVG');
    const arrowsLayer = $('#arrowsLayer');
    const tempLayer = $('#tempLayer');
    const playerLayer = $('#playerLayer');

    const modeChips = $$('.chip');
    const addHomeBtn = $('#addHome'), addAwayBtn = $('#addAway'), addBallBtn = $('#addBall');
    const arrowStyleEl = $('#arrowStyle'), arrowWidthEl = $('#arrowWidth'), arrowColorEl = $('#arrowColor');
    const zoomRange = $('#zoomRange'), zoomLabel = $('#zoomLabel'), snapGrid = $('#snapGrid');

    const playPauseBtn = $('#playPause'), playProgress = $('#playProgress'), frameLabel = $('#frameLabel');

    const selInfo = $('#selInfo');

    /* Coordinate helpers */
    function pxToSvg(pxX, pxY){
      const rect = pitchCard.getBoundingClientRect();
      const x = ((pxX - rect.left) / rect.width) * VB.w;
      const y = ((pxY - rect.top) / rect.height) * VB.h;
      return {x, y};
    }
    function svgToPct(sx, sy){ return {x: (sx / VB.w) * 100, y: (sy / VB.h) * 100}; }
    function pctToSvg(pxPctX, pxPctY){ return {x: pxPctX * (VB.w/100), y: pxPctY * (VB.h/100)}; }

    /* Rendering */
    function renderPlayers(){
      playerLayer.innerHTML = '';
      App.players.forEach(p => {
        const el = document.createElement('div');
        el.className = 'player ' + (p.type === 'away' ? 'away' : (p.type === 'ball' ? 'ball' : 'home'));
        el.style.left = p.xPct + '%';
        el.style.top = p.yPct + '%';
        el.dataset.uid = p.uid;
        el.textContent = p.type === 'ball' ? 'B' : (p.label || p.type.toUpperCase());
        el.title = p.label || p.type;
        playerLayer.appendChild(el);
        attachPlayerHandlers(el, p);
      });
    }

    function renderArrows(){
      arrowsLayer.innerHTML = '';
      App.arrows.forEach(a => {
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        const start = {x: a.x1, y: a.y1}, end = {x: a.x2, y: a.y2};
        let d;
        if(a.control && typeof a.control.cx === 'number'){
          d = `M ${start.x} ${start.y} Q ${a.control.cx} ${a.control.cy} ${end.x} ${end.y}`;
        } else if(a.style === 'curved'){
          const mx = (start.x + end.x) / 2, my = (start.y + end.y) / 2;
          const dx = end.x - start.x, dy = end.y - start.y;
          const dist = Math.hypot(dx, dy) || 1;
          const nx = -dy/dist, ny = dx/dist;
          const offset = clamp(dist * 0.18, 30, 200);
          const cx = mx + nx * offset, cy = my + ny * offset;
          d = `M ${start.x} ${start.y} Q ${cx} ${cy} ${end.x} ${end.y}`;
        } else {
          d = `M ${start.x} ${start.y} L ${end.x} ${end.y}`;
        }
        path.setAttribute('d', d);
        path.setAttribute('class','arrowLine');
        path.setAttribute('stroke', a.color || '#ffd166');
        path.setAttribute('stroke-width', a.width || 3);
        if(a.style === 'dashed') path.setAttribute('stroke-dasharray','12 8');
        if(a.style === 'glow') path.setAttribute('filter','url(#glow)');
        path.setAttribute('marker-end', a.style === 'glow' ? 'url(#arrowHeadGlow)' : 'url(#arrowHead)');
        path.dataset.aid = a.id;
        arrowsLayer.appendChild(path);
      });
    }

    /* Player events/dragging */
    let drag = null;
    function attachPlayerHandlers(el, model){
      el.addEventListener('pointerdown', ev => {
        ev.stopPropagation(); ev.preventDefault();
        if(App.mode === 'draw' || App.mode === 'curve'){
          startDrawingFrom(model, ev);
          return;
        }
        if(App.mode === 'erase'){
          removePlayer(model.uid);
          return;
        }
        // select + start drag
        setSelected(model.uid);
        drag = {uid: model.uid, startClient: {x: ev.clientX, y: ev.clientY}, orig: {xPct: model.xPct, yPct: model.yPct}};
        el.setPointerCapture(ev.pointerId);
        el.style.cursor = 'grabbing';
      });

      el.addEventListener('pointermove', ev => {
        if(!drag || drag.uid !== model.uid) return;
        ev.preventDefault();
        const rect = pitchCard.getBoundingClientRect();
        const dx = ev.clientX - drag.startClient.x;
        const dy = ev.clientY - drag.startClient.y;
        const percentX = (dx / rect.width) * 100;
        const percentY = (dy / rect.height) * 100;
        let nx = drag.orig.xPct + percentX;
        let ny = drag.orig.yPct + percentY;
        nx = clamp(nx, 1, 99); ny = clamp(ny, 1, 99);
        if($('#snapGrid').checked){ nx = Math.round(nx/2)*2; ny = Math.round(ny/2)*2; }
        const p = App.players.find(pp => pp.uid === model.uid);
        if(p){ p.xPct = nx; p.yPct = ny; renderPlayers(); renderArrows(); }
      });

      el.addEventListener('pointerup', ev => {
        if(drag && drag.uid === model.uid){
          pushUndo();
          saveLocal();
        }
        drag = null;
        try{ el.releasePointerCapture(ev.pointerId);}catch(e){}
        el.style.cursor = 'grab';
      });

      el.addEventListener('dblclick', ev => {
        ev.stopPropagation();
        const label = prompt('Label', model.label || '');
        if(label !== null){
          pushUndo();
          model.label = label;
          renderPlayers(); saveLocal();
        }
      });
    }

    /* Selection */
    let selectedUid = null;
    function setSelected(uid){
      selectedUid = uid;
      $$('.player').forEach(el => el.classList.toggle('selected', el.dataset.uid === uid));
      updateSelectionInfo();
    }
    function updateSelectionInfo(){
      if(!selectedUid){ selInfo.innerHTML = 'Type: — <br> Team: — <br> Label: —'; return; }
      const p = App.players.find(x => x.uid === selectedUid);
      if(!p) { selInfo.innerHTML = 'Type: —'; return; }
      selInfo.innerHTML = `Type: <b>${p.type}</b><br>Team: <b>${p.type==='away'?'Away':'Home'}</b><br>Label: <b>${p.label||'-'}</b>`;
    }

    /* Add / remove */
    function addPlayer(type='home'){
      pushUndo();
      const p = {
        uid: uid('p_'),
        type,
        xPct: 20 + Math.random()*60,
        yPct: 20 + Math.random()*60,
        label: type==='home' ? 'ST' : (type==='away' ? 'OP' : 'BALL'),
      };
      App.players.push(p);
      renderPlayers(); renderArrows(); saveLocal();
    }
    function removePlayer(uid){
      pushUndo();
      App.players = App.players.filter(p => p.uid !== uid);
      App.arrows = App.arrows.filter(a => a.fromUid !== uid && a.toUid !== uid);
      renderPlayers(); renderArrows(); setSelected(null); saveLocal();
    }

    /* Drawing arrows */
    function startDrawingFrom(player, ev){
      const start = pctToSvg(player.xPct, player.yPct);
      App.drawing = {fromUid: player.uid, start: {...start}, cur: {...start}, tempElem: null};
      renderTemp();
    }

    function renderTemp(){
      tempLayer.innerHTML = '';
      if(!App.drawing) return;
      const d = `M ${App.drawing.start.x} ${App.drawing.start.y} L ${App.drawing.cur.x} ${App.drawing.cur.y}`;
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', d);
      path.setAttribute('stroke', arrowColorEl.value);
      path.setAttribute('stroke-width', arrowWidthEl.value);
      path.setAttribute('class','arrowLine');
      path.setAttribute('stroke-opacity','0.8');
      path.setAttribute('marker-end', arrowStyleEl.value === 'glow' ? 'url(#arrowHeadGlow)' : 'url(#arrowHead)');
      tempLayer.appendChild(path);
      App.drawing.tempElem = path;
    }

    document.addEventListener('pointermove', ev => {
      if(!App.drawing) return;
      const p = pxToSvg(ev.clientX, ev.clientY);
      App.drawing.cur.x = p.x; App.drawing.cur.y = p.y;
      // curve preview if selected
      if(arrowStyleEl.value === 'curved'){
        const mx = (App.drawing.start.x + App.drawing.cur.x)/2;
        const my = (App.drawing.start.y + App.drawing.cur.y)/2;
        const dx = App.drawing.cur.x - App.drawing.start.x;
        const dy = App.drawing.cur.y - App.drawing.start.y;
        const dist = Math.hypot(dx,dy) || 1;
        const nx = -dy/dist, ny = dx/dist;
        const offset = clamp(dist * 0.18, 30, 200);
        const cx = mx + nx * offset, cy = my + ny * offset;
        App.drawing.tempElem.setAttribute('d', `M ${App.drawing.start.x} ${App.drawing.start.y} Q ${cx} ${cy} ${App.drawing.cur.x} ${App.drawing.cur.y}`);
      } else {
        App.drawing.tempElem.setAttribute('d', `M ${App.drawing.start.x} ${App.drawing.start.y} L ${App.drawing.cur.x} ${App.drawing.cur.y}`);
      }
    });

    // complete draw on pointerup: if hitting a player, connect to player; else create free-arrow
    document.addEventListener('pointerup', ev => {
      if(!App.drawing) return;
      const target = ev.target;
      if(target && target.classList && target.classList.contains('player')){
        const toUid = target.dataset.uid;
        if(toUid && toUid !== App.drawing.fromUid){
          const fromP = App.players.find(p => p.uid === App.drawing.fromUid);
          const toP = App.players.find(p => p.uid === toUid);
          if(fromP && toP){
            pushUndo();
            const a = {
              id: uid('a_'),
              fromUid: fromP.uid,
              toUid: toP.uid,
              x1: pctToSvg(fromP.xPct, fromP.yPct).x,
              y1: pctToSvg(fromP.xPct, fromP.yPct).y,
              x2: pctToSvg(toP.xPct, toP.yPct).x,
              y2: pctToSvg(toP.xPct, toP.yPct).y,
              style: arrowStyleEl.value,
              width: Number(arrowWidthEl.value),
              color: arrowColorEl.value,
              control: arrowStyleEl.value==='curved' ? computeAutoControl(fromP, toP) : null
            };
            App.arrows.push(a);
            renderArrows(); saveLocal();
          }
        }
      } else {
        // free arrow to point
        pushUndo();
        const a = {
          id: uid('a_'),
          fromUid: null,
          toUid: null,
          x1: App.drawing.start.x, y1: App.drawing.start.y,
          x2: App.drawing.cur.x, y2: App.drawing.cur.y,
          style: arrowStyleEl.value,
          width: Number(arrowWidthEl.value),
          color: arrowColorEl.value,
          control: null
        };
        App.arrows.push(a);
        renderArrows(); saveLocal();
      }
      App.drawing = null; tempLayer.innerHTML = '';
    });

    function computeAutoControl(fromP, toP){
      const A = pctToSvg(fromP.xPct, fromP.yPct), B = pctToSvg(toP.xPct, toP.yPct);
      const mx = (A.x + B.x)/2, my = (A.y + B.y)/2;
      const dx = B.x - A.x, dy = B.y - A.y;
      const dist = Math.hypot(dx, dy) || 1;
      const nx = -dy/dist, ny = dx/dist;
      const offset = clamp(dist * 0.18, 30, 200);
      return {cx: mx + nx*offset, cy: my + ny*offset};
    }

    /* Undo / Redo */
    function pushUndo(){
      App.undoStack.push(JSON.stringify({players: App.players, arrows: App.arrows}));
      if(App.undoStack.length > 50) App.undoStack.shift();
      App.redoStack = [];
    }
    $('#btnUndo').addEventListener('click', () => {
      const s = App.undoStack.pop(); if(!s) return;
      App.redoStack.push(JSON.stringify({players: App.players, arrows: App.arrows}));
      const parsed = JSON.parse(s);
      App.players = parsed.players || []; App.arrows = parsed.arrows || [];
      renderPlayers(); renderArrows(); saveLocal();
    });
    $('#btnRedo').addEventListener('click', () => {
      const s = App.redoStack.pop(); if(!s) return;
      App.undoStack.push(JSON.stringify({players: App.players, arrows: App.arrows}));
      const parsed = JSON.parse(s);
      App.players = parsed.players || []; App.arrows = parsed.arrows || [];
      renderPlayers(); renderArrows(); saveLocal();
    });

    /* Save / load local */
    function saveLocal(){
      try{ localStorage.setItem('protactix_v1', JSON.stringify({players: App.players, arrows: App.arrows})); }catch(e){}
    }
    function loadLocal(){
      try{
        const raw = localStorage.getItem('protactix_v1'); if(!raw) return;
        const parsed = JSON.parse(raw);
        App.players = parsed.players || []; App.arrows = parsed.arrows || [];
      }catch(e){}
    }

    /* Export / Import */
    $('#btnExport').addEventListener('click', () => {
      const data = JSON.stringify({players: App.players, arrows: App.arrows}, null, 2);
      const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'protactix_setup.json'; a.click(); URL.revokeObjectURL(url);
    });
    $('#btnImport').addEventListener('click', () => $('#fileInput').click());
    $('#btnExportJSON').addEventListener('click', () => $('#btnExport').click());
    $('#btnLoadJSON').addEventListener('click', () => $('#fileInput').click());
    $('#fileInput').addEventListener('change', ev => {
      const f = ev.target.files[0]; if(!f) return;
      const r = new FileReader(); r.onload = e => { try{ const parsed = JSON.parse(e.target.result); pushUndo(); App.players = parsed.players||[]; App.arrows = parsed.arrows||[]; renderPlayers(); renderArrows(); saveLocal(); alert('Loaded'); }catch(err){ alert('Invalid JSON'); }}; r.readAsText(f);
    });

    /* UI bindings */
    modeChips.forEach(chip => chip.addEventListener('click', () => {
      modeChips.forEach(c=>c.classList.remove('active')); chip.classList.add('active');
      App.mode = chip.dataset.mode;
    }));
    addHomeBtn.addEventListener('click', ()=> addPlayer('home'));
    addAwayBtn.addEventListener('click', ()=> addPlayer('away'));
    addBallBtn.addEventListener('click', ()=> addPlayer('ball'));

    $('#btnClear').addEventListener('click', ()=> { if(confirm('Clear pitch?')){ pushUndo(); App.players=[]; App.arrows=[]; renderPlayers(); renderArrows(); saveLocal(); }});
    $('#btnReset').addEventListener('click', ()=> { pitchCard.style.transform = ''; zoomRange.value = 1; zoomLabel.textContent = '100%'; });

    zoomRange.addEventListener('input', e => { const s = parseFloat(e.target.value); pitchCard.style.transform = `scale(${s})`; zoomLabel.textContent = Math.round(s*100) + '%'; });

    $('#btnDelete').addEventListener('click', ()=> { if(selectedUid && confirm('Delete selected?')) removePlayer(selectedUid); });

    /* pitch click deselect */
    pitchCard.addEventListener('pointerdown', ev => {
      if(ev.target === pitchCard || ev.target === pitchSVG) { setSelected(null); }
    });

    /* keyboard shortcuts */
    document.addEventListener('keydown', ev => {
      if(ev.key === 's') setModeUI('select');
      if(ev.key === 'd') setModeUI('draw');
      if(ev.key === 'c') setModeUI('curve');
      if(ev.key === 'e') setModeUI('erase');
      if(ev.key === 'Delete' && selectedUid) { if(confirm('Delete selected?')) removePlayer(selectedUid); }
      if((ev.ctrlKey||ev.metaKey) && ev.key === 'z') $('#btnUndo').click();
      if((ev.ctrlKey||ev.metaKey) && ev.key === 'y') $('#btnRedo').click();
    });

    function setModeUI(mode){
      App.mode = mode;
      modeChips.forEach(c => c.classList.toggle('active', c.dataset.mode === mode));
    }

    /* keep arrows attached to players on loop */
    function layoutLoop(){
      App.arrows.forEach(a => {
        if(a.fromUid){
          const f = App.players.find(p => p.uid === a.fromUid);
          if(f){ const s = pctToSvg(f.xPct, f.yPct); a.x1 = s.x; a.y1 = s.y; }
        }
        if(a.toUid){
          const t = App.players.find(p => p.uid === a.toUid);
          if(t){ const s = pctToSvg(t.xPct, t.yPct); a.x2 = s.x; a.y2 = s.y; }
        }
      });
      renderArrows();
      requestAnimationFrame(layoutLoop);
    }
    layoutLoop();

    /* helpers */
    function pctToSvg(xPct, yPct){ return {x: xPct * (VB.w/100), y: yPct * (VB.h/100)}; }

    /* initial data */
    (function init(){
      // sample players if none saved
      loadLocal();
      if(App.players.length === 0){
        App.players = [
          {uid:uid('p_'), type:'home', xPct:20, yPct:50, label:'ST'},
          {uid:uid('p_'), type:'home', xPct:35, yPct:30, label:'LW'},
          {uid:uid('p_'), type:'home', xPct:35, yPct:70, label:'RW'},
          {uid:uid('p_'), type:'away', xPct:80, yPct:50, label:'CB'},
          {uid:uid('p_'), type:'away', xPct:65, yPct:30, label:'LB'},
          {uid:uid('p_'), type:'ball', xPct:50, yPct:50, label:'B'}
        ];
      }
      renderPlayers(); renderArrows(); updateSelectionInfo();
    })();

    /* small UX: remove selection on window blur to avoid stuck states */
    window.addEventListener('blur', () => { setSelected(null); App.drawing = null; tempLayer.innerHTML = ''; });

  </script>
</body>
</html>
