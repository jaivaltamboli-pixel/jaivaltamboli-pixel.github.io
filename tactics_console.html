<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProTactix | Professional Football Tactics Console ‚Äî v6 (complete with zones)</title>
  <style>
    :root {
      --primary: #0a1128;
      --secondary: #001f54;
      --accent: #034078;
      --highlight: #1282a2;
      --danger: #e63946;
      --success: #2a9d8f;
      --warning: #e9c46a;
      --text: #f1faee;
      --muted: #a8dadc;
      --dark: #1d3557;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --transition: all 0.28s cubic-bezier(.2,.9,.3,1);
    }

    * { box-sizing: border-box; margin:0; padding:0; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
    html,body { height:100%; background: linear-gradient(135deg,var(--primary),var(--secondary)); color:var(--text); -webkit-font-smoothing:antialiased; }

    .app-container {
      display: grid;
      grid-template-columns: 300px 1fr 340px;
      grid-template-rows: 80px 1fr;
      gap:0;
      height:100vh;
    }

    /* Header */
    header {
      grid-column:1/-1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 28px;
      background: rgba(10,17,40,0.95);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
      z-index: 1000;
    }
    .logo { display:flex; align-items:center; gap:12px; }
    .logo-icon { width:44px; height:44px; border-radius:8px; background:var(--highlight); display:flex;align-items:center;justify-content:center;font-weight:800; }
    .logo-text { font-size:20px; font-weight:800; background: linear-gradient(90deg,var(--text),var(--muted)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    .header-controls { display:flex; gap:10px; align-items:center; }
    .btn {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.06);
      color: var(--text);
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      transition: var(--transition);
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:600;
    }
    .btn:hover { transform:translateY(-3px); background: rgba(255,255,255,0.08); }
    .btn.success { background: rgba(42,157,143,0.12); border-color: rgba(42,157,143,0.2); }
    .btn.danger { background: rgba(230,57,70,0.12); border-color: rgba(230,57,70,0.2); }
    .btn.active { background: rgba(18,130,162,0.2); border-color: rgba(18,130,162,0.4); }

    /* Sidebar */
    .sidebar {
      background: rgba(13,23,42,0.9);
      backdrop-filter: blur(6px);
      border-right: 1px solid rgba(255,255,255,0.04);
      padding:22px;
      overflow-y:auto;
    }
    .tool-group {
      background: rgba(255,255,255,0.03);
      border-radius:12px;
      padding:16px;
      margin-bottom:18px;
      border:1px solid rgba(255,255,255,0.03);
    }
    .sidebar-title, .tool-group-title { font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; color:var(--muted); }
    .btn-group { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
    .btn.small { padding:8px 10px; font-size:14px; }

    .formation-select, .slider, .zone-input { width:100%; padding:10px; border-radius:8px; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.03); color:var(--text); }
    .slider { height:8px; }

    /* Main */
    .main-content {
      padding:22px;
      display:flex;
      flex-direction:column;
      gap:14px;
      overflow:hidden;
    }
    .pitch-container {
      flex:1;
      background: linear-gradient(160deg,#0d4b22,#176a2f);
      border-radius:14px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.45);
      position:relative;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.04);
      padding:10px;
    }
    .pitch { width:100%; height:100%; position:relative; }

    svg.pitch-lines { position:absolute; inset:0; overflow:visible; width:100%; height:100%; pointer-events:none; }

    .player {
      position:absolute;
      width:54px;
      height:54px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      cursor:pointer;
      transform: translate(-50%,-50%);
      z-index: 120;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      transition: var(--transition);
    }
    .player.home { background:var(--highlight); color:var(--text); border:3px solid rgba(255,255,255,0.9); }
    .player.away { background:var(--danger); color:var(--text); border:3px solid rgba(255,255,255,0.9); }
    .player.ball { width:38px; height:38px; background:var(--text); color:var(--dark); border:3px solid var(--dark); font-size:13px; }

    .player.selected { transform:translate(-50%,-50%) scale(1.14); box-shadow:0 0 0 4px rgba(233,201,106,0.28); }

    /* arrow overlay */
    .arrow-overlay {
      position:absolute;
      inset:0;
      z-index:110;
      pointer-events: none;
    }

    /* arrow styles - FIXED */
    .arrow-line {
      stroke: #e63946; /* Changed to red */
      stroke-width: 2;
      stroke-linecap: round;
      fill: none;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); /* Reduced shadow */
      pointer-events: all;
      cursor:pointer;
    }
    .arrow-highlight {
      stroke: rgba(255,255,255,0.7); /* Changed to white with transparency */
      stroke-width: 3;
      stroke-linecap: round;
      fill: none;
      pointer-events: none;
    }
    .arrow.selected .arrow-line { stroke: #ffffff; stroke-width: 2.5; }
    .arrow.selected .arrow-highlight { stroke: rgba(255,255,255,0.9); stroke-width: 4; }

    .arrow-dashed {
      stroke-dasharray: 5, 5;
    }

    /* Zone styles */
    .zone {
      position: absolute;
      border: 2px solid rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      cursor: pointer;
      z-index: 50;
      transition: var(--transition);
    }
    .zone.selected {
      border: 3px solid var(--warning);
      background: rgba(233,196,106,0.15);
      box-shadow: 0 0 0 2px rgba(233,196,106,0.3);
    }
    .zone-label {
      position: absolute;
      top: 5px;
      left: 5px;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
      font-size: 14px;
      pointer-events: none;
    }

    /* Replay controls */
    .replay-controls {
      background: rgba(13,23,42,0.9);
      border-radius:12px;
      padding:12px;
      display:flex;
      align-items:center;
      gap:12px;
      border:1px solid rgba(255,255,255,0.03);
    }

    /* right panel */
    .right-panel {
      background: rgba(13,23,42,0.9);
      padding:22px;
      border-left: 1px solid rgba(255,255,255,0.04);
      overflow-y:auto;
    }
    .panel-section { background: rgba(255,255,255,0.02); padding:14px; border-radius:10px; margin-bottom:18px; border:1px solid rgba(255,255,255,0.03); }

    /* responsive */
    @media (max-width:1200px) {
      .app-container { grid-template-columns: 260px 1fr; }
      .right-panel { display:none; }
    }
    @media (max-width:800px) {
      .app-container { grid-template-columns: 1fr; grid-template-rows: 80px auto 1fr; }
      .sidebar { grid-row:2; }
      .main-content { grid-row:3; }
    }

  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="logo">
        <div class="logo-icon">PT</div>
        <div class="logo-text">ProTactix</div>
      </div>
      <div class="header-controls">
        <button class="btn" id="btn-new-project">+ New Project</button>
        <button class="btn success" id="btn-export">‚Üì Export</button>
        <button class="btn" id="btn-settings">‚öô Settings</button>
      </div>
    </header>

    <aside class="sidebar">
      <div class="tool-group">
        <div class="sidebar-title">Design Tools</div>
        <div class="btn-group">
          <button id="btn-select" class="btn small active">Select</button>
          <button id="btn-draw" class="btn small">Draw</button>
          <button id="btn-zone" class="btn small">Add Zone</button>
        </div>

        <div class="btn-group">
          <button id="btn-player" class="btn small">Add Player</button>
          <button id="btn-ball" class="btn small">Add Ball</button>
        </div>
      </div>

      <div class="tool-group">
        <div class="tool-group-title">Formations</div>
        <select id="formation-select" class="formation-select">
          <option value="">Select Formation</option>
          <option value="4-4-2">4-4-2 Classic</option>
          <option value="4-3-3">4-3-3 Attacking</option>
          <option value="3-5-2">3-5-2 Defensive</option>
          <option value="4-2-3-1">4-2-3-1 Modern</option>
        </select>
        <button id="btn-apply-formation" class="btn small" style="width:100%;">‚úì Apply Formation</button>
      </div>

      <div class="tool-group">
        <div class="tool-group-title">Arrow Styles</div>
        <div class="btn-group">
          <button class="btn small arrow-style active" data-style="loafted" id="style-loafted">Loafted</button>
          <button class="btn small arrow-style" data-style="simple" id="style-simple">Simple</button>
        </div>
        <div class="btn-group">
          <button class="btn small arrow-style" data-style="curved" id="style-curved">Curved</button>
          <button class="btn small arrow-style" data-style="dashed" id="style-dashed">Dashed</button>
        </div>

        <div style="margin-top:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;color:var(--muted);font-weight:600;">
            <div>Arrow Thickness</div>
            <div id="arrow-thickness-label">2px</div>
          </div>
          <input id="arrow-thickness" class="slider" type="range" min="1" max="6" value="2" />
        </div>
      </div>

      <div class="tool-group">
        <div class="tool-group-title">Zone Controls</div>
        <input type="text" id="zone-name" class="zone-input" placeholder="Zone name (e.g., Attack)" style="margin-bottom:10px;">
        <div class="btn-group">
          <button id="btn-add-zone" class="btn small">Add Zone</button>
          <button id="btn-remove-zone" class="btn small danger">Remove Zone</button>
        </div>
        <div style="margin-top:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;color:var(--muted);font-weight:600;">
            <div>Zone Opacity</div>
            <div id="zone-opacity-label">30%</div>
          </div>
          <input id="zone-opacity" class="slider" type="range" min="10" max="70" value="30" />
        </div>
      </div>

      <!-- View Controls -->
      <div class="tool-group">
        <div class="tool-group-title">View Controls</div>
        <div style="margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;color:var(--muted);font-weight:600;margin-bottom:6px;">
            <div>Zoom</div><div id="zoom-label">100%</div>
          </div>
          <input id="zoom-control" class="slider" type="range" min="50" max="150" value="100" />
        </div>

        <div>
          <div style="display:flex;justify-content:space-between;color:var(--muted);font-weight:600;margin-bottom:6px;">
            <div>Field Brightness</div><div id="brightness-label">70%</div>
          </div>
          <input id="brightness-control" class="slider" type="range" min="30" max="100" value="70" />
        </div>

        <div style="margin-top:10px;">
          <button id="btn-3d-toggle" class="btn small">‚óë 3D View</button>
        </div>
      </div>

      <!-- Delete buttons moved below View Controls as requested -->
      <div class="tool-group">
        <button id="btn-delete" class="btn danger" style="width:100%; margin-bottom:10px;">üóë Delete Selected</button>
        <button id="btn-delete-arrow" class="btn danger" style="width:100%;">üóë Delete Arrow</button>
      </div>

    </aside>

    <main class="main-content">
      <div class="pitch-container">
        <div class="pitch" id="pitch">
          <!-- static pitch lines -->
          <svg class="pitch-lines" viewBox="0 0 100 60" preserveAspectRatio="none" aria-hidden="true">
            <defs>
              <linearGradient id="fieldG" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0" stop-color="#0e5d2a"/>
                <stop offset="1" stop-color="#136a2f"/>
              </linearGradient>
            </defs>
            <rect x="0" y="0" width="100" height="60" fill="transparent" stroke="white" stroke-width="0.3" stroke-opacity="0.08"/>
            <line x1="50" y1="0" x2="50" y2="60" stroke="white" stroke-width="0.25" stroke-opacity="0.06" />
            <circle cx="50" cy="30" r="7" stroke="white" stroke-width="0.25" stroke-opacity="0.06" fill="transparent" />
            <!-- penalty boxes -->
            <rect x="0" y="18" width="12" height="24" fill="transparent" stroke="white" stroke-width="0.25" stroke-opacity="0.06" />
            <rect x="88" y="18" width="12" height="24" fill="transparent" stroke="white" stroke-width="0.25" stroke-opacity="0.06" />
            <rect x="0" y="26" width="2" height="8" fill="transparent" stroke="white" stroke-width="0.25" stroke-opacity="0.06" />
            <rect x="98" y="26" width="2" height="8" fill="transparent" stroke="white" stroke-width="0.25" stroke-opacity="0.06" />
          </svg>

          <!-- initial players -->
          <div class="player home" style="left:20%; top:30%;">ST</div>
          <div class="player home" style="left:15%; top:50%;">LW</div>
          <div class="player home" style="left:15%; top:10%;">RW</div>
          <div class="player away" style="left:80%; top:30%;">CB</div>
          <div class="player away" style="left:85%; top:50%;">LB</div>
          <div class="player away" style="left:85%; top:10%;">RB</div>
          <div class="player ball" style="left:50%; top:30%;">B</div>

          <!-- arrow overlay SVG -->
          <svg class="arrow-overlay" id="arrow-overlay" viewBox="0 0 100 60" preserveAspectRatio="none"></svg>
        </div>
      </div>

      <div class="replay-controls">
        <button class="btn" id="re-prev">‚èÆ</button>
        <button class="btn" id="re-play">‚èØ</button>
        <button class="btn" id="re-next">‚è≠</button>
        <div style="flex:1;height:8px;background:rgba(255,255,255,0.04);border-radius:8px;overflow:hidden;position:relative;">
          <div id="re-progress" style="width:0%;height:100%;background:var(--highlight);"></div>
        </div>
        <button class="btn" id="re-stop">‚èπ</button>
        <button class="btn" id="re-loop">‚Ü∫</button>
      </div>
    </main>

    <aside class="right-panel">
      <div class="panel-section">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:800">Player Details</div>
          <div style="color:var(--muted)">Live</div>
        </div>

        <div style="display:grid;grid-template-columns:60px 1fr;gap:12px;align-items:center;margin-top:12px;">
          <div style="width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--highlight);font-weight:700;">ST</div>
          <div>
            <div style="font-weight:800">Striker</div>
            <div style="color:var(--muted)">Home Team ¬∑ Forward</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;">
          <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;">
            <div style="font-weight:800">85%</div>
            <div style="color:var(--muted)">Pass Accuracy</div>
          </div>
          <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;">
            <div style="font-weight:800">12</div>
            <div style="color:var(--muted)">Goals</div>
          </div>
        </div>
      </div>

      <div class="panel-section">
        <div style="font-weight:800;margin-bottom:10px;">Tactical Presets</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="btn" data-formation="4-4-2">4-4-2</div>
          <div class="btn" data-formation="4-3-3">4-3-3</div>
          <div class="btn" data-formation="3-5-2">3-5-2</div>
          <div class="btn" data-formation="4-2-3-1">4-2-3-1</div>
        </div>
      </div>

      <div class="panel-section">
        <div style="font-weight:800;margin-bottom:10px;">Match Stats</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;">
            <div style="font-weight:800">64%</div>
            <div style="color:var(--muted)">Possession</div>
          </div>
          <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;">
            <div style="font-weight:800">12</div>
            <div style="color:var(--muted)">Shots</div>
          </div>
        </div>
      </div>

      <div class="panel-section">
        <div style="font-weight:800;margin-bottom:8px;">Recent Actions</div>
        <div id="recent-actions" style="color:var(--muted);font-size:13px;line-height:1.6;">
          <div>‚Üí App started</div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // Complete working version with all features
    document.addEventListener('DOMContentLoaded', function() {
      // State
      const state = {
        mode: 'select',
        selectedElement: null,
        arrows: [],
        players: [],
        zones: [],
        arrowStyle: 'loafted',
        is3D: false
      };

      // DOM Elements
      const pitch = document.getElementById('pitch');
      const arrowOverlay = document.getElementById('arrow-overlay');
      const recentActions = document.getElementById('recent-actions');
      
      // Buttons
      const btnSelect = document.getElementById('btn-select');
      const btnDraw = document.getElementById('btn-draw');
      const btnZone = document.getElementById('btn-zone');
      const btnPlayer = document.getElementById('btn-player');
      const btnBall = document.getElementById('btn-ball');
      const btnDelete = document.getElementById('btn-delete');
      const btnDeleteArrow = document.getElementById('btn-delete-arrow');
      const btnApplyFormation = document.getElementById('btn-apply-formation');
      const formationSelect = document.getElementById('formation-select');
      const arrowThickness = document.getElementById('arrow-thickness');
      const arrowThicknessLabel = document.getElementById('arrow-thickness-label');
      const zoomControl = document.getElementById('zoom-control');
      const brightnessControl = document.getElementById('brightness-control');
      const arrowStyleButtons = document.querySelectorAll('.arrow-style');
      const btn3DToggle = document.getElementById('btn-3d-toggle');
      const btnNewProject = document.getElementById('btn-new-project');
      const btnExport = document.getElementById('btn-export');
      const btnSettings = document.getElementById('btn-settings');
      const btnAddZone = document.getElementById('btn-add-zone');
      const btnRemoveZone = document.getElementById('btn-remove-zone');
      const zoneNameInput = document.getElementById('zone-name');
      const zoneOpacity = document.getElementById('zone-opacity');
      const zoneOpacityLabel = document.getElementById('zone-opacity-label');
      const rePrev = document.getElementById('re-prev');
      const rePlay = document.getElementById('re-play');
      const reNext = document.getElementById('re-next');
      const reStop = document.getElementById('re-stop');
      const reLoop = document.getElementById('re-loop');
      const reProgress = document.getElementById('re-progress');

      // Initialize players from DOM
      function initPlayers() {
        const players = pitch.querySelectorAll('.player');
        players.forEach(player => {
          state.players.push(player);
          player.addEventListener('click', function(e) {
            e.stopPropagation();
            selectElement(player);
          });
          
          // Make players draggable
          makeDraggable(player);
        });
      }

      // Make element draggable
      function makeDraggable(element) {
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;
        
        element.addEventListener('mousedown', startDrag);
        
        function startDrag(e) {
          if (state.mode !== 'select') return;
          
          e.preventDefault();
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          
          // Get initial position
          initialLeft = parseFloat(element.style.left);
          initialTop = parseFloat(element.style.top);
          
          document.addEventListener('mousemove', drag);
          document.addEventListener('mouseup', stopDrag);
          
          // Select the element being dragged
          selectElement(element);
        }
        
        function drag(e) {
          if (!isDragging) return;
          
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;
          
          // Calculate new position in percentages
          const rect = pitch.getBoundingClientRect();
          const newLeft = initialLeft + (deltaX / rect.width) * 100;
          const newTop = initialTop + (deltaY / rect.height) * 100;
          
          // Boundary checks
          element.style.left = Math.max(0, Math.min(100, newLeft)) + '%';
          element.style.top = Math.max(0, Math.min(100, newTop)) + '%';
        }
        
        function stopDrag() {
          isDragging = false;
          document.removeEventListener('mousemove', drag);
          document.removeEventListener('mouseup', stopDrag);
        }
      }

      // Select element
      function selectElement(element) {
        // Clear previous selection
        if (state.selectedElement) {
          state.selectedElement.classList.remove('selected');
        }
        
        // Deselect all zones
        document.querySelectorAll('.zone').forEach(zone => {
          zone.classList.remove('selected');
        });
        
        // Select new element
        state.selectedElement = element;
        element.classList.add('selected');
        logAction(`Selected ${element.textContent}`);
      }

      // Clear selection
      function clearSelection() {
        if (state.selectedElement) {
          state.selectedElement.classList.remove('selected');
          state.selectedElement = null;
        }
        
        // Deselect all zones
        document.querySelectorAll('.zone').forEach(zone => {
          zone.classList.remove('selected');
        });
      }

      // Add player
      function addPlayer() {
        const positions = ['ST', 'LW', 'RW', 'CM', 'CB', 'LB', 'RB', 'GK'];
        const label = positions[Math.floor(Math.random() * positions.length)];
        const player = document.createElement('div');
        player.className = 'player home';
        player.textContent = label;
        player.style.left = '50%';
        player.style.top = '50%';
        
        player.addEventListener('click', function(e) {
          e.stopPropagation();
          selectElement(player);
        });
        
        makeDraggable(player);
        pitch.appendChild(player);
        state.players.push(player);
        logAction(`Added player: ${label}`);
      }

      // Add ball
      function addBall() {
        const ball = document.createElement('div');
        ball.className = 'player ball';
        ball.textContent = 'B';
        ball.style.left = '50%';
        ball.style.top = '50%';
        
        ball.addEventListener('click', function(e) {
          e.stopPropagation();
          selectElement(ball);
        });
        
        makeDraggable(ball);
        pitch.appendChild(ball);
        state.players.push(ball);
        logAction('Added ball');
      }

      // Delete selected
      function deleteSelected() {
        if (state.selectedElement) {
          const element = state.selectedElement;
          element.remove();
          state.players = state.players.filter(p => p !== element);
          state.selectedElement = null;
          logAction('Deleted selected element');
        }
      }

      // Apply formation
      function applyFormation() {
        const formation = formationSelect.value;
        if (!formation) return;
        
        // Clear existing players (except ball)
        state.players.forEach(player => {
          if (!player.classList.contains('ball')) {
            player.remove();
          }
        });
        state.players = state.players.filter(p => p.classList.contains('ball'));
        
        // Add formation players
        const formations = {
          '4-4-2': [
            {pos: 'GK', left: '5%', top: '50%'},
            {pos: 'LB', left: '20%', top: '20%'},
            {pos: 'CB', left: '20%', top: '40%'},
            {pos: 'CB', left: '20%', top: '60%'},
            {pos: 'RB', left: '20%', top: '80%'},
            {pos: 'LM', left: '45%', top: '20%'},
            {pos: 'CM', left: '45%', top: '40%'},
            {pos: 'CM', left: '45%', top: '60%'},
            {pos: 'RM', left: '45%', top: '80%'},
            {pos: 'ST', left: '75%', top: '35%'},
            {pos: 'ST', left: '75%', top: '65%'}
          ],
          '4-3-3': [
            {pos: 'GK', left: '5%', top: '50%'},
            {pos: 'LB', left: '20%', top: '25%'},
            {pos: 'CB', left: '20%', top: '50%'},
            {pos: 'CB', left: '20%', top: '75%'},
            {pos: 'RB', left: '20%', top: '25%'},
            {pos: 'CM', left: '45%', top: '35%'},
            {pos: 'CM', left: '45%', top: '50%'},
            {pos: 'CM', left: '45%', top: '65%'},
            {pos: 'LW', left: '80%', top: '20%'},
            {pos: 'ST', left: '80%', top: '50%'},
            {pos: 'RW', left: '80%', top: '80%'}
          ],
          '3-5-2': [
            {pos: 'GK', left: '5%', top: '50%'},
            {pos: 'CB', left: '15%', top: '25%'},
            {pos: 'CB', left: '15%', top: '50%'},
            {pos: 'CB', left: '15%', top: '75%'},
            {pos: 'LM', left: '35%', top: '20%'},
            {pos: 'CM', left: '35%', top: '40%'},
            {pos: 'CM', left: '35%', top: '60%'},
            {pos: 'RM', left: '35%', top: '80%'},
            {pos: 'AM', left: '60%', top: '50%'},
            {pos: 'ST', left: '80%', top: '35%'},
            {pos: 'ST', left: '80%', top: '65%'}
          ],
          '4-2-3-1': [
            {pos: 'GK', left: '5%', top: '50%'},
            {pos: 'LB', left: '20%', top: '25%'},
            {pos: 'CB', left: '20%', top: '50%'},
            {pos: 'CB', left: '20%', top: '75%'},
            {pos: 'RB', left: '20%', top: '25%'},
            {pos: 'CDM', left: '40%', top: '35%'},
            {pos: 'CDM', left: '40%', top: '65%'},
            {pos: 'LW', left: '65%', top: '20%'},
            {pos: 'CAM', left: '65%', top: '50%'},
            {pos: 'RW', left: '65%', top: '80%'},
            {pos: 'ST', left: '85%', top: '50%'}
          ]
        };
        
        const formationPlayers = formations[formation] || formations['4-4-2'];
        
        formationPlayers.forEach(playerData => {
          const player = document.createElement('div');
          player.className = 'player home';
          player.textContent = playerData.pos;
          player.style.left = playerData.left;
          player.style.top = playerData.top;
          
          player.addEventListener('click', function(e) {
            e.stopPropagation();
            selectElement(player);
          });
          
          makeDraggable(player);
          pitch.appendChild(player);
          state.players.push(player);
        });
        
        logAction(`Applied ${formation} formation`);
      }

      // Draw arrow - IMPROVED
      function drawArrow(startX, startY, endX, endY) {
        // Create a group for the arrow
        const arrowGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        arrowGroup.setAttribute('class', 'arrow');
        
        // Create highlight layer (thicker line underneath)
        const highlight = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        highlight.setAttribute('class', 'arrow-highlight');
        
        // Create main arrow line
        const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        arrow.setAttribute('class', 'arrow-line');
        
        // Apply style based on current arrow style
        let dValue;
        switch(state.arrowStyle) {
          case 'simple':
            dValue = `M${startX},${startY} L${endX},${endY}`;
            break;
          case 'curved':
            dValue = `M${startX},${startY} Q${(startX + endX)/2},${Math.min(startY, endY) - 8} ${endX},${endY}`;
            break;
          case 'dashed':
            dValue = `M${startX},${startY} L${endX},${endY}`;
            arrow.classList.add('arrow-dashed');
            break;
          case 'loafted':
          default:
            dValue = `M${startX},${startY} Q${(startX + endX)/2},${Math.min(startY, endY) - 8} ${endX},${endY}`;
            break;
        }
        
        highlight.setAttribute('d', dValue);
        arrow.setAttribute('d', dValue);
        
        // Add arrowhead
        const arrowHead = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        const headSize = 4;
        const angle = Math.atan2(endY - startY, endX - startX);
        
        // Calculate arrowhead points
        const headX1 = endX - headSize * Math.cos(angle - Math.PI/6);
        const headY1 = endY - headSize * Math.sin(angle - Math.PI/6);
        const headX2 = endX - headSize * Math.cos(angle + Math.PI/6);
        const headY2 = endY - headSize * Math.sin(angle + Math.PI/6);
        
        arrowHead.setAttribute('points', `${endX},${endY} ${headX1},${headY1} ${headX2},${headY2}`);
        arrowHead.setAttribute('fill', '#e63946'); // Red arrowhead
        
        arrowGroup.appendChild(highlight);
        arrowGroup.appendChild(arrow);
        arrowGroup.appendChild(arrowHead);
        arrowOverlay.appendChild(arrowGroup);
        
        // Store arrow data
        state.arrows.push({arrowGroup, arrow, highlight, arrowHead});
        
        // Make arrow selectable
        arrowGroup.addEventListener('click', function(e) {
          e.stopPropagation();
          selectArrow(arrowGroup);
        });
        
        logAction(`Added ${state.arrowStyle} arrow`);
      }

      // Select arrow
      function selectArrow(arrowGroup) {
        // Clear previous selection
        document.querySelectorAll('.arrow').forEach(a => a.classList.remove('selected'));
        
        // Select new arrow
        arrowGroup.classList.add('selected');
        logAction('Selected arrow');
      }

      // Delete selected arrow
      function deleteSelectedArrow() {
        const selectedArrow = document.querySelector('.arrow.selected');
        if (selectedArrow) {
          const arrowIndex = state.arrows.findIndex(a => a.arrowGroup === selectedArrow);
          if (arrowIndex !== -1) {
            state.arrows[arrowIndex].arrowGroup.remove();
            state.arrows.splice(arrowIndex, 1);
            logAction('Deleted selected arrow');
          }
        } else {
          alert('Please select an arrow first by clicking on it');
        }
      }

      // Add zone
      function addZone() {
        const zoneName = zoneNameInput.value || 'Zone ' + (state.zones.length + 1);
        
        const zone = document.createElement('div');
        zone.className = 'zone';
        zone.style.left = '30%';
        zone.style.top = '20%';
        zone.style.width = '40%';
        zone.style.height = '60%';
        
        const zoneLabel = document.createElement('div');
        zoneLabel.className = 'zone-label';
        zoneLabel.textContent = zoneName;
        zone.appendChild(zoneLabel);
        
        zone.addEventListener('click', function(e) {
          e.stopPropagation();
          selectZone(zone);
        });
        
        // Make zone draggable and resizable
        makeZoneDraggable(zone);
        
        pitch.appendChild(zone);
        state.zones.push(zone);
        logAction(`Added zone: ${zoneName}`);
      }

      // Select zone
      function selectZone(zone) {
        // Clear previous selection
        if (state.selectedElement) {
          state.selectedElement.classList.remove('selected');
          state.selectedElement = null;
        }
        
        // Deselect all zones
        document.querySelectorAll('.zone').forEach(z => {
          z.classList.remove('selected');
        });
        
        // Select new zone
        zone.classList.add('selected');
        logAction(`Selected zone: ${zone.querySelector('.zone-label').textContent}`);
      }

      // Make zone draggable and resizable
      function makeZoneDraggable(zone) {
        let isDragging = false;
        let isResizing = false;
        let startX, startY, initialLeft, initialTop, initialWidth, initialHeight;
        
        zone.addEventListener('mousedown', startDrag);
        
        function startDrag(e) {
          if (state.mode !== 'select') return;
          
          e.preventDefault();
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          
          // Get initial position and size
          initialLeft = parseFloat(zone.style.left);
          initialTop = parseFloat(zone.style.top);
          initialWidth = parseFloat(zone.style.width);
          initialHeight = parseFloat(zone.style.height);
          
          // Check if resizing (click near edge)
          const rect = zone.getBoundingClientRect();
          const threshold = 10; // pixels from edge
          
          if (e.clientX > rect.right - threshold && e.clientY > rect.bottom - threshold) {
            isResizing = true;
          } else {
            isResizing = false;
          }
          
          document.addEventListener('mousemove', drag);
          document.addEventListener('mouseup', stopDrag);
          
          // Select the zone being dragged
          selectZone(zone);
        }
        
        function drag(e) {
          if (!isDragging) return;
          
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;
          
          // Calculate new position/size in percentages
          const rect = pitch.getBoundingClientRect();
          
          if (isResizing) {
            // Resize the zone
            const newWidth = initialWidth + (deltaX / rect.width) * 100;
            const newHeight = initialHeight + (deltaY / rect.height) * 100;
            
            // Boundary checks
            zone.style.width = Math.max(5, Math.min(100 - initialLeft, newWidth)) + '%';
            zone.style.height = Math.max(5, Math.min(100 - initialTop, newHeight)) + '%';
          } else {
            // Move the zone
            const newLeft = initialLeft + (deltaX / rect.width) * 100;
            const newTop = initialTop + (deltaY / rect.height) * 100;
            
            // Boundary checks
            zone.style.left = Math.max(0, Math.min(100 - initialWidth, newLeft)) + '%';
            zone.style.top = Math.max(0, Math.min(100 - initialHeight, newTop)) + '%';
          }
        }
        
        function stopDrag() {
          isDragging = false;
          document.removeEventListener('mousemove', drag);
          document.removeEventListener('mouseup', stopDrag);
        }
      }

      // Remove selected zone
      function removeSelectedZone() {
        const selectedZone = document.querySelector('.zone.selected');
        if (selectedZone) {
          selectedZone.remove();
          state.zones = state.zones.filter(z => z !== selectedZone);
          logAction('Removed selected zone');
        } else {
          alert('Please select a zone first by clicking on it');
        }
      }

      // Set mode
      function setMode(mode) {
        state.mode = mode;
        btnSelect.classList.toggle('active', mode === 'select');
        btnDraw.classList.toggle('active', mode === 'draw');
        btnZone.classList.toggle('active', mode === 'zone');
        
        if (mode === 'draw') {
          pitch.style.cursor = 'crosshair';
        } else if (mode === 'zone') {
          pitch.style.cursor = 'crosshair';
        } else {
          pitch.style.cursor = 'default';
        }
        
        logAction(`Mode: ${mode}`);
      }

      // Toggle 3D view
      function toggle3DView() {
        state.is3D = !state.is3D;
        if (state.is3D) {
          pitch.style.transform = 'perspective(1000px) rotateX(45deg)';
          btn3DToggle.classList.add('active');
          logAction('Enabled 3D view');
        } else {
          pitch.style.transform = 'none';
          btn3DToggle.classList.remove('active');
          logAction('Disabled 3D view');
        }
      }

      // New project
      function newProject() {
        if (confirm('Are you sure you want to create a new project? All unsaved changes will be lost.')) {
          // Clear all elements
          state.players.forEach(player => player.remove());
          state.arrows.forEach(arrow => arrow.arrowGroup.remove());
          state.zones.forEach(zone => zone.remove());
          
          // Reset state
          state.players = [];
          state.arrows = [];
          state.zones = [];
          state.selectedElement = null;
          
          // Add default players and ball
          addDefaultPlayers();
          
          logAction('Created new project');
        }
      }

      // Add default players
      function addDefaultPlayers() {
        const defaultPlayers = [
          {pos: 'ST', left: '20%', top: '30%', team: 'home'},
          {pos: 'LW', left: '15%', top: '50%', team: 'home'},
          {pos: 'RW', left: '15%', top: '10%', team: 'home'},
          {pos: 'CB', left: '80%', top: '30%', team: 'away'},
          {pos: 'LB', left: '85%', top: '50%', team: 'away'},
          {pos: 'RB', left: '85%', top: '10%', team: 'away'}
        ];
        
        defaultPlayers.forEach(playerData => {
          const player = document.createElement('div');
          player.className = `player ${playerData.team}`;
          player.textContent = playerData.pos;
          player.style.left = playerData.left;
          player.style.top = playerData.top;
          
          player.addEventListener('click', function(e) {
            e.stopPropagation();
            selectElement(player);
          });
          
          makeDraggable(player);
          pitch.appendChild(player);
          state.players.push(player);
        });
        
        // Add ball
        addBall();
      }

      // Export project
      function exportProject() {
        logAction('Project exported as image');
        alert('Project exported successfully! (This would download an image in a real implementation)');
      }

      // Open settings
      function openSettings() {
        logAction('Settings opened');
        alert('Settings dialog would open here in a real implementation');
      }

      // Replay controls
      function setupReplayControls() {
        let isPlaying = false;
        let progress = 0;
        
        rePlay.addEventListener('click', function() {
          isPlaying = !isPlaying;
          if (isPlaying) {
            rePlay.textContent = '‚è∏';
            logAction('Replay started');
            
            // Simulate progress
            const interval = setInterval(() => {
              if (isPlaying && progress < 100) {
                progress += 2;
                reProgress.style.width = progress + '%';
              } else {
                clearInterval(interval);
                isPlaying = false;
                rePlay.textContent = '‚èØ';
                if (progress >= 100) {
                  progress = 0;
                  reProgress.style.width = '0%';
                }
              }
            }, 100);
          } else {
            rePlay.textContent = '‚èØ';
            logAction('Replay paused');
          }
        });
        
        reStop.addEventListener('click', function() {
          isPlaying = false;
          progress = 0;
          reProgress.style.width = '0%';
          rePlay.textContent = '‚èØ';
          logAction('Replay stopped');
        });
        
        rePrev.addEventListener('click', function() {
          progress = Math.max(0, progress - 10);
          reProgress.style.width = progress + '%';
          logAction('Replay rewound');
        });
        
        reNext.addEventListener('click', function() {
          progress = Math.min(100, progress + 10);
          reProgress.style.width = progress + '%';
          logAction('Replay fast forwarded');
        });
        
        reLoop.addEventListener('click', function() {
          this.classList.toggle('active');
          logAction('Loop ' + (this.classList.contains('active') ? 'enabled' : 'disabled'));
        });
      }

      // Log action
      function logAction(text) {
        const div = document.createElement('div');
        div.textContent = `‚Üí ${text}`;
        recentActions.prepend(div);
        
        // Keep only last 10 actions
        while (recentActions.children.length > 10) {
          recentActions.removeChild(recentActions.lastChild);
        }
      }

      // Event Listeners
      btnSelect.addEventListener('click', () => setMode('select'));
      btnDraw.addEventListener('click', () => setMode('draw'));
      btnZone.addEventListener('click', () => setMode('zone'));
      btnPlayer.addEventListener('click', addPlayer);
      btnBall.addEventListener('click', addBall);
      btnDelete.addEventListener('click', deleteSelected);
      btnDeleteArrow.addEventListener('click', deleteSelectedArrow);
      btnApplyFormation.addEventListener('click', applyFormation);
      btn3DToggle.addEventListener('click', toggle3DView);
      btnNewProject.addEventListener('click', newProject);
      btnExport.addEventListener('click', exportProject);
      btnSettings.addEventListener('click', openSettings);
      btnAddZone.addEventListener('click', addZone);
      btnRemoveZone.addEventListener('click', removeSelectedZone);
      
      // Arrow thickness
      arrowThickness.addEventListener('input', function() {
        const thickness = this.value;
        arrowThicknessLabel.textContent = `${thickness}px`;
        
        // Update all arrows
        document.querySelectorAll('.arrow-line').forEach(arrow => {
          arrow.setAttribute('stroke-width', thickness);
        });
        
        document.querySelectorAll('.arrow-highlight').forEach(highlight => {
          highlight.setAttribute('stroke-width', parseInt(thickness) + 1);
        });
      });
      
      // Zone opacity
      zoneOpacity.addEventListener('input', function() {
        const opacity = this.value;
        zoneOpacityLabel.textContent = `${opacity}%`;
        
        // Update all zones
        document.querySelectorAll('.zone').forEach(zone => {
          zone.style.background = `rgba(255,255,255,${opacity/100})`;
        });
      });
      
      // Zoom control
      zoomControl.addEventListener('input', function() {
        document.getElementById('zoom-label').textContent = `${this.value}%`;
        pitch.style.transform = `scale(${this.value / 100})`;
      });
      
      // Brightness control
      brightnessControl.addEventListener('input', function() {
        document.getElementById('brightness-label').textContent = `${this.value}%`;
        document.querySelector('.pitch-container').style.filter = `brightness(${this.value}%)`;
      });
      
      // Arrow styles
      arrowStyleButtons.forEach(button => {
        button.addEventListener('click', function() {
          arrowStyleButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          state.arrowStyle = this.dataset.style;
          logAction(`Arrow style: ${state.arrowStyle}`);
        });
      });
      
      // Tactical presets
      document.querySelectorAll('.right-panel .btn[data-formation]').forEach(btn => {
        btn.addEventListener('click', function() {
          formationSelect.value = this.dataset.formation;
          applyFormation();
        });
      });
      
      // Pitch click for drawing arrows and zones
      let drawing = false;
      let startX, startY;
      
      pitch.addEventListener('mousedown', function(e) {
        if (state.mode === 'draw') {
          const rect = pitch.getBoundingClientRect();
          startX = ((e.clientX - rect.left) / rect.width) * 100;
          startY = ((e.clientY - rect.top) / rect.height) * 60;
          drawing = true;
        } else if (state.mode === 'zone') {
          const rect = pitch.getBoundingClientRect();
          startX = ((e.clientX - rect.left) / rect.width) * 100;
          startY = ((e.clientY - rect.top) / rect.height) * 100;
          drawing = true;
        } else {
          clearSelection();
        }
      });
      
      pitch.addEventListener('mouseup', function(e) {
        if ((state.mode === 'draw' || state.mode === 'zone') && drawing) {
          const rect = pitch.getBoundingClientRect();
          const endX = ((e.clientX - rect.left) / rect.width) * 100;
          const endY = ((e.clientY - rect.top) / rect.height) * (state.mode === 'draw' ? 60 : 100);
          
          if (state.mode === 'draw') {
            drawArrow(startX, startY, endX, endY);
          } else if (state.mode === 'zone') {
            // Create zone with the drawn rectangle
            const zoneName = zoneNameInput.value || 'Zone ' + (state.zones.length + 1);
            const zone = document.createElement('div');
            zone.className = 'zone';
            
            // Calculate position and size
            const left = Math.min(startX, endX);
            const top = Math.min(startY, endY);
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);
            
            zone.style.left = left + '%';
            zone.style.top = top + '%';
            zone.style.width = width + '%';
            zone.style.height = height + '%';
            
            const zoneLabel = document.createElement('div');
            zoneLabel.className = 'zone-label';
            zoneLabel.textContent = zoneName;
            zone.appendChild(zoneLabel);
            
            zone.addEventListener('click', function(e) {
              e.stopPropagation();
              selectZone(zone);
            });
            
            // Make zone draggable and resizable
            makeZoneDraggable(zone);
            
            pitch.appendChild(zone);
            state.zones.push(zone);
            logAction(`Added zone: ${zoneName}`);
          }
          
          drawing = false;
        }
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        // Delete key
        if (e.key === 'Delete' || e.key === 'Backspace') {
          deleteSelected();
        }
        
        // R key for reset
        if (e.key.toLowerCase() === 'r') {
          applyFormation();
        }
        
        // Number keys for formations
        if (e.key >= '1' && e.key <= '4') {
          const formations = ['4-4-2', '4-3-3', '3-5-2', '4-2-3-1'];
          formationSelect.value = formations[parseInt(e.key) - 1];
          applyFormation();
        }
      });

      // Initialize
      initPlayers();
      setupReplayControls();
      logAction('ProTactix v6 initialized with zones feature');
    });
  </script>
</body>
</html>
