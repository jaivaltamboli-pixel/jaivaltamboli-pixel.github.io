<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tactics Console — Interactive</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --navy:#001F5B;
    --accent:#FFA500;
    --bg:#eaf0f6;
    --tile:#ffffff;
    --muted:#666;
  }
  html,body{height:100%;margin:0;font-family:Roboto,system-ui,-apple-system; background:linear-gradient(135deg,var(--bg),#d4e0eb); color:#111}
  /* Fullscreen app container */
  .app {
    position:fixed; inset:0; display:flex; flex-direction:column;
  }

  /* Top bar */
  .topbar{
    height:72px; background:var(--navy); color:var(--accent); display:flex; align-items:center; gap:14px;
    padding:12px 20px; box-shadow:0 6px 20px rgba(0,0,0,0.25);
  }
  .topbar h1{font-family:Oswald;margin:0;font-size:1.25rem; letter-spacing:2px}
  .topbar .subtitle{color:#e9c88a; font-size:0.9rem; margin-left:8px}
  .topbar .actions{margin-left:auto; display:flex; gap:10px; align-items:center}

  /* Buttons */
  .btn {
    background:var(--accent); color:var(--navy); border:none; padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer;
    box-shadow:0 6px 14px rgba(0,0,0,0.12);
  }
  .btn.ghost{background:transparent;color:white;border:1px solid rgba(255,255,255,0.12)}
  .btn.small{padding:6px 10px;font-size:0.9rem}
  .icon-btn {background:transparent;border:1px solid rgba(255,255,255,0.08); color: #fff; padding:6px;border-radius:8px;cursor:pointer}

  /* Main area */
  .main {
    display:flex; gap:18px; padding:18px; height:calc(100% - 72px);
  }

  /* Left toolbar */
  .toolbar {
    width:260px; background:var(--tile); border-radius:12px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,0.08);
    display:flex; flex-direction:column; gap:12px;
  }
  .toolbar h3{font-family:Oswald;margin:0 0 6px 0; color:var(--navy); font-size:1.05rem}
  .tool-row{display:flex; gap:8px; flex-wrap:wrap}
  .tool-row label{font-size:0.85rem; color:var(--muted)}
  .formation-select{width:100%; padding:8px; border-radius:8px; border:1px solid #ddd}

  /* Center pitch area */
  .canvas-wrap {
    flex:1; display:flex; align-items:center; justify-content:center; position:relative;
  }
  .pitch {
    width:1100px; max-width:calc(100vw - 360px); height:640px; background:linear-gradient(#2d8b3b,#1f7a33); border-radius:10px; position:relative;
    border:6px solid #fff; box-shadow:0 20px 40px rgba(0,0,0,0.25); overflow:hidden;
    transform-origin:center center;
  }
  /* center lines and markings with pseudo elements */
  .pitch .markings{position:absolute; inset:0; pointer-events:none}
  .pitch .markings svg{width:100%;height:100%;display:block}

  /* Players */
  .player {
    width:44px;height:44px;border-radius:50%;position:absolute;display:flex;align-items:center;justify-content:center;
    font-weight:700;color:#001F5B;border:3px solid #fff; cursor:grab; user-select:none; box-shadow:0 6px 14px rgba(0,0,0,0.25);
    transition:transform .08s linear;
  }
  .player.home{background:var(--accent)}
  .player.away{background:#ffffff;color:var(--navy);border:3px solid var(--accent)}
  .player.dragging{transform:scale(1.08); cursor:grabbing}

  /* Ball */
  .ball {
    width:22px;height:22px;border-radius:50%; background:#fff;border:3px solid #111; position:absolute; display:flex;align-items:center;justify-content:center;box-shadow:0 8px 18px rgba(0,0,0,0.25); cursor:grab;
  }

  /* SVG arrows layer */
  #arrowLayer { position:absolute; inset:0; pointer-events:none; }

  /* Toolbar controls style */
  .tool-block { background:#fbfbfb;border-radius:8px;padding:10px;border:1px solid #eee }
  label { display:block; font-size:0.85rem; color:#444; margin-bottom:6px }

  /* Small text */
  .muted { color:#666; font-size:0.9rem }

  /* Right panel */
  .rightpanel { width:240px; display:flex; flex-direction:column; gap:12px }
  .rightpanel .panel { background:var(--tile); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06) }

  /* footnote */
  .hint { font-size:0.85rem; color:#555 }

  /* responsive */
  @media(max-width:1100px){
    .toolbar{display:none}
    .rightpanel{display:none}
    .pitch{max-width:calc(100vw - 40px);height:60vh}
  }
</style>
</head>
<body>

<div class="app">

  <!-- TOP -->
  <div class="topbar">
    <h1>TACTICS CONSOLE</h1>
    <div class="subtitle">Build formations • draw runs • save setups</div>

    <div class="actions">
      <button id="exitBtn" class="btn small ghost">Back</button>
      <button id="undoBtn" class="btn small">Undo</button>
      <button id="clearArrowsBtn" class="btn small">Clear Arrows</button>
      <button id="saveBtn" class="btn small">Save</button>
      <button id="downloadBtn" class="btn small">Download JSON</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- LEFT toolbar -->
    <aside class="toolbar" aria-label="Toolbox">
      <h3>Tools</h3>

      <div class="tool-row">
        <button id="selectTool" class="btn small">Select</button>
        <button id="drawTool" class="btn small">Draw</button>
        <button id="eraseTool" class="btn small">Erase</button>
      </div>

      <div class="tool-block">
        <label>Add entity</label>
        <div class="tool-row">
          <button id="addHome" class="btn">Add Home</button>
          <button id="addAway" class="btn ghost">Add Away</button>
        </div>
        <div style="height:8px"></div>
        <button id="addBall" class="btn">Add Ball</button>
        <div style="height:8px"></div>
        <button id="removeSelected" class="btn ghost">Remove Selected</button>
      </div>

      <div class="tool-block">
        <label>Formations</label>
        <select id="formationSelect" class="formation-select">
          <option value="">— choose preset —</option>
          <option value="4-3-3">4 - 3 - 3</option>
          <option value="4-4-2">4 - 4 - 2</option>
          <option value="3-5-2">3 - 5 - 2</option>
        </select>
        <div style="height:10px"></div>
        <button id="applyFormation" class="btn">Apply Formation</button>
      </div>

      <div class="tool-block">
        <label>Zoom</label>
        <input id="zoomRange" type="range" min="0.6" max="1.4" step="0.05" value="1" />
        <div class="muted">Scale field</div>
      </div>

      <div class="tool-block">
        <label>Record Movement</label>
        <div style="display:flex;gap:8px">
          <button id="startRec" class="btn">Record</button>
          <button id="stopRec" class="btn ghost">Stop</button>
        </div>
        <div class="muted">Recording saves frames to download</div>
      </div>

      <div style="flex:1"></div>

      <div class="muted" style="font-size:0.85rem">Tip: hold and drag players. Use Draw for runs. Save layouts to local storage.</div>
    </aside>

    <!-- CENTER pitch -->
    <div class="canvas-wrap" role="main">
      <div id="pitch" class="pitch" tabindex="0">
        <!-- arrows (SVG) -->
        <svg id="arrowLayer" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
              <path d="M0,0 L10,3.5 L0,7 Z" fill="#FFA500"/>
            </marker>
          </defs>
        </svg>

        <!-- markings layer -->
        <div class="markings" aria-hidden="true">
          <svg viewBox="0 0 1100 640" preserveAspectRatio="none">
            <rect x="40" y="40" width="1020" height="560" rx="6" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="2"/>
            <!-- halfway -->
            <line x1="600" y1="40" x2="600" y2="600" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
            <circle cx="600" cy="320" r="60" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1.5"/>
            <!-- penalty boxes -->
            <rect x="40" y="160" width="160" height="320" rx="4" fill="none" stroke="rgba(255,255,255,0.5)"/>
            <rect x="980" y="160" width="160" height="320" rx="4" fill="none" stroke="rgba(255,255,255,0.5)"/>
            <circle cx="150" cy="320" r="6" fill="rgba(255,255,255,0.9)"/>
            <circle cx="1050" cy="320" r="6" fill="rgba(255,255,255,0.9)"/>
          </svg>
        </div>

      </div>
    </div>

    <!-- RIGHT panel -->
    <aside class="rightpanel">
      <div class="panel">
        <strong>Selection</strong>
        <div id="selectedInfo" style="margin-top:8px" class="muted">None selected</div>
      </div>

      <div class="panel">
        <strong>Saved layouts</strong>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="loadLocal" class="btn ghost small">Load</button>
          <button id="clearLocal" class="btn small">Clear</button>
        </div>
        <div style="height:8px"></div>
        <div class="muted">Local saves are stored in your browser.</div>
      </div>

      <div class="panel">
        <strong>Export / Import</strong>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="importInput" type="file" accept="application/json" style="flex:1"/>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- SCRIPT -->
<script>
/* -------------------------
  Tactics Console JS
   - drag/drop players & ball
   - draw arrows (SVG)
   - erase arrows
   - add/remove entities
   - formations
   - save/load JSON (localStorage + download)
   - record frames (download JSON)
   - zoom (scale)
---------------------------*/

(() => {
  const pitch = document.getElementById('pitch');
  const arrowLayer = document.getElementById('arrowLayer');
  const selectTool = document.getElementById('selectTool');
  const drawTool = document.getElementById('drawTool');
  const eraseTool = document.getElementById('eraseTool');
  const addHome = document.getElementById('addHome');
  const addAway = document.getElementById('addAway');
  const addBall = document.getElementById('addBall');
  const removeSelected = document.getElementById('removeSelected');
  const formationSelect = document.getElementById('formationSelect');
  const applyFormation = document.getElementById('applyFormation');
  const zoomRange = document.getElementById('zoomRange');
  const saveBtn = document.getElementById('saveBtn');
  const loadLocal = document.getElementById('loadLocal');
  const clearLocal = document.getElementById('clearLocal');
  const downloadBtn = document.getElementById('downloadBtn');
  const importInput = document.getElementById('importInput');
  const selectedInfo = document.getElementById('selectedInfo');
  const undoBtn = document.getElementById('undoBtn');
  const clearArrowsBtn = document.getElementById('clearArrowsBtn');
  const startRec = document.getElementById('startRec');
  const stopRec = document.getElementById('stopRec');
  const exitBtn = document.getElementById('exitBtn');

  // state
  let tool = 'select'; // select, draw, erase
  let dragging = null;
  let dragOffset = {x:0,y:0};
  let selected = null;
  let arrows = []; // {el, x1,y1,x2,y2}
  let undoStack = [];
  let recordFrames = [];
  let recording = false;
  let drawTempLine = null;
  let arrowIdCounter = 0;

  // pitch coordinate helpers (we use pitch client coordinates)
  function bounds(el){
    const r = el.getBoundingClientRect();
    return {left:r.left, top:r.top, width:r.width, height:r.height};
  }

  /* ------- utilities ------- */
  function makePlayer(team='home', label='') {
    const el = document.createElement('div');
    el.className = 'player ' + (team==='home' ? 'home' : 'away');
    el.dataset.type = 'player';
    el.dataset.team = team;
    el.dataset.label = label || (team==='home' ? 'H' : 'A');
    el.textContent = el.dataset.label;
    // center by default
    el.style.left = (pitch.clientWidth/2 - 22) + 'px';
    el.style.top = (pitch.clientHeight/2 - 22) + 'px';
    appendEntity(el);
    return el;
  }

  function makeBall() {
    const el = document.createElement('div');
    el.className = 'ball';
    el.dataset.type = 'ball';
    el.style.left = (pitch.clientWidth/2 - 11) + 'px';
    el.style.top = (pitch.clientHeight/2 - 11) + 'px';
    appendEntity(el);
    el.textContent = '';
    return el;
  }

  function appendEntity(el) {
    pitch.appendChild(el);
    attachEntityEvents(el);
    pushUndo({op:'add', node:el});
    if(recording) captureFrame();
  }

  function attachEntityEvents(el){
    el.addEventListener('mousedown', e => {
      if(tool !== 'select') return;
      dragging = el;
      el.classList.add('dragging');
      const br = pitch.getBoundingClientRect();
      dragOffset.x = e.clientX - el.offsetLeft - br.left;
      dragOffset.y = e.clientY - el.offsetTop - br.top;
      selected = el;
      updateSelectedInfo();
      e.preventDefault();
    });

    el.addEventListener('click', e => {
      if(tool === 'erase' && el.dataset.type === 'player') {
        el.remove();
        pushUndo({op:'remove', node:el});
        selected = null; updateSelectedInfo();
      } else if(tool === 'select') {
        selected = el; updateSelectedInfo();
      }
    });
  }

  // mouse move on document for dragging players
  document.addEventListener('mousemove', e => {
    if(!dragging) return;
    const br = pitch.getBoundingClientRect();
    const x = e.clientX - br.left - dragOffset.x;
    const y = e.clientY - br.top - dragOffset.y;
    // clamp inside pitch
    const w = dragging.offsetWidth, h = dragging.offsetHeight;
    const nx = Math.max(0, Math.min(br.width - w, x));
    const ny = Math.max(0, Math.min(br.height - h, y));
    dragging.style.left = nx + 'px';
    dragging.style.top = ny + 'px';
    if(recording) captureFrame();
  });

  document.addEventListener('mouseup', e => {
    if(dragging) {
      dragging.classList.remove('dragging');
      pushUndo({op:'move', node:dragging, x:dragging.style.left, y:dragging.style.top});
      dragging = null;
    }
    if(tool === 'draw' && drawTempLine) {
      // finalize line on mouseup if released inside pitch
      removeTempLine();
    }
  });

  // clicking on pitch when drawing arrows
  pitch.addEventListener('mousedown', (e) => {
    const br = pitch.getBoundingClientRect();
    const px = e.clientX - br.left;
    const py = e.clientY - br.top;
    if(tool === 'draw') {
      startDraw(px,py);
    } else if (tool === 'erase') {
      // erase nearest arrow if clicked
      eraseNearestArrow(px,py);
    } else {
      // select none if clicked on empty pitch
      if(e.target === pitch || e.target.classList.contains('markings')){
        selected = null; updateSelectedInfo();
      }
    }
  });

  // drawing helpers
  function startDraw(x,y){
    // create a temporary line element under arrowLayer
    drawTempLine = document.createElementNS('http://www.w3.org/2000/svg','line');
    drawTempLine.setAttribute('x1', x);
    drawTempLine.setAttribute('y1', y);
    drawTempLine.setAttribute('x2', x);
    drawTempLine.setAttribute('y2', y);
    drawTempLine.setAttribute('stroke', '#FFA500');
    drawTempLine.setAttribute('stroke-width','6');
    drawTempLine.setAttribute('stroke-linecap','round');
    drawTempLine.setAttribute('opacity','0.95');
    arrowLayer.appendChild(drawTempLine);
    // listen for mousemove to update
    function move(e){
      const br = pitch.getBoundingClientRect();
      const nx = e.clientX - br.left;
      const ny = e.clientY - br.top;
      drawTempLine.setAttribute('x2', nx);
      drawTempLine.setAttribute('y2', ny);
    }
    function up(e){
      document.removeEventListener('mousemove', move);
      document.removeEventListener('mouseup', up);
      const br = pitch.getBoundingClientRect();
      const x2 = parseFloat(drawTempLine.getAttribute('x2'));
      const y2 = parseFloat(drawTempLine.getAttribute('y2'));
      // create final arrow element
      const final = document.createElementNS('http://www.w3.org/2000/svg','line');
      final.setAttribute('x1', drawTempLine.getAttribute('x1'));
      final.setAttribute('y1', drawTempLine.getAttribute('y1'));
      final.setAttribute('x2', x2);
      final.setAttribute('y2', y2);
      final.setAttribute('stroke', '#FFA500');
      final.setAttribute('stroke-width','6');
      final.setAttribute('stroke-linecap','round');
      final.setAttribute('marker-end','url(#arrowhead)');
      final.dataset.arrowId = 'a'+(++arrowIdCounter);
      final.style.cursor = 'pointer';
      arrowLayer.appendChild(final);
      arrows.push(final);
      pushUndo({op:'add-arrow', node:final});
      // make arrow clickable/selectable for erase
      final.addEventListener('click', (evt) => {
        if(tool === 'erase') {
          final.remove();
          arrows = arrows.filter(a=>a!==final);
        } else {
          // select arrow (shows info)
          selected = final;
          updateSelectedInfo();
        }
        evt.stopPropagation();
      });
      drawTempLine.remove();
      drawTempLine = null;
      if(recording) captureFrame();
    }
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
  }

  function removeTempLine(){
    if(drawTempLine){ drawTempLine.remove(); drawTempLine=null; }
  }

  function eraseNearestArrow(px,py){
    if(arrows.length===0) return;
    let best=null, bestDist=1e9;
    arrows.forEach(a=>{
      const x1 = +a.getAttribute('x1'), y1 = +a.getAttribute('y1');
      const x2 = +a.getAttribute('x2'), y2 = +a.getAttribute('y2');
      // closest distance to segment
      const t = Math.max(0, Math.min(1, ((px-x1)*(x2-x1)+(py-y1)*(y2-y1))/((x2-x1)**2+(y2-y1)**2||1)));
      const cx = x1 + t*(x2-x1), cy = y1 + t*(y2-y1);
      const d = Math.hypot(px-cx,py-cy);
      if(d < bestDist){ bestDist = d; best = a; }
    });
    if(best && bestDist < 20){
      best.remove();
      arrows = arrows.filter(a=>a!==best);
      pushUndo({op:'remove-arrow', node:best});
    }
  }

  /* ------- tool switching ------- */
  function setTool(t){
    tool = t;
    selectTool.classList.toggle('active', t==='select');
    drawTool.classList.toggle('active', t==='draw');
    eraseTool.classList.toggle('active', t==='erase');
    // visual feedback
    [selectTool, drawTool, eraseTool].forEach(btn=>{
      btn.style.opacity = (btn === document.getElementById(btn.id) ? '1' : '0.95');
    });
  }

  selectTool.addEventListener('click', ()=> setTool('select'));
  drawTool.addEventListener('click', ()=> setTool('draw'));
  eraseTool.addEventListener('click', ()=> setTool('erase'));
  setTool('select');

  /* ------- add/remove ------- */
  addHome.addEventListener('click', ()=> makePlayer('home', 'H'));
  addAway.addEventListener('click', ()=> makePlayer('away', 'A'));
  addBall.addEventListener('click', ()=> makeBall());

  removeSelected.addEventListener('click', ()=>{
    if(!selected) return alert('No selection');
    if(selected instanceof SVGElement){
      selected.remove();
      arrows = arrows.filter(a=>a!==selected);
    } else selected.remove();
    pushUndo({op:'remove', node:selected});
    selected = null; updateSelectedInfo();
  });

  function makePlayer(team,label){
    const el = document.createElement('div');
    el.className = 'player ' + (team==='home'?'home':'away');
    el.dataset.type = 'player';
    el.dataset.team = team;
    el.dataset.label = label || (team==='home'?'H':'A');
    el.textContent = el.dataset.label;
    // random pos (not overlapping top-left)
    const x = Math.random()*(pitch.clientWidth-60)+30;
    const y = Math.random()*(pitch.clientHeight-120)+60;
    el.style.left = x+'px'; el.style.top = y+'px';
    pitch.appendChild(el);
    attachEntityEvents(el);
    pushUndo({op:'add', node:el});
    if(recording) captureFrame();
    return el;
  }

  function makeBall(){
    const el = document.createElement('div');
    el.className = 'ball';
    el.dataset.type = 'ball';
    const x = Math.random()*(pitch.clientWidth-60)+30;
    const y = Math.random()*(pitch.clientHeight-60)+30;
    el.style.left = x+'px'; el.style.top = y+'px';
    pitch.appendChild(el);
    attachEntityEvents(el);
    pushUndo({op:'add', node:el});
    if(recording) captureFrame();
    return el;
  }

  /* attach events for players/ball on initial load */
  function attachEntityEvents(el){
    // only allow dragging inside pitch via mousedown
    el.addEventListener('mousedown', e => {
      if(tool !== 'select') return;
      dragging = el;
      el.classList.add('dragging');
      const br = pitch.getBoundingClientRect();
      dragOffset.x = e.clientX - br.left - el.offsetLeft;
      dragOffset.y = e.clientY - br.top - el.offsetTop;
      selected = el; updateSelectedInfo();
      e.preventDefault();
    });
    el.addEventListener('click', (ev) => {
      ev.stopPropagation();
      if(tool === 'erase'){
        // remove entity
        const node = el;
        node.remove();
        pushUndo({op:'remove', node});
        selected = null; updateSelectedInfo();
      } else {
        selected = el; updateSelectedInfo();
      }
    });
  }

  /* ------- formations ------- */
  const formations = {
    "4-3-3": [
      {team:'home', label:'GK', xPct:50, yPct:87},
      {team:'home', label:'LB', xPct:18, yPct:68},
      {team:'home', label:'CB', xPct:40, yPct:68},
      {team:'home', label:'CB2', xPct:60, yPct:68},
      {team:'home', label:'RB', xPct:82, yPct:68},
      {team:'home', label:'CM', xPct:36, yPct:50},
      {team:'home', label:'CM2', xPct:50, yPct:52},
      {team:'home', label:'CM3', xPct:64, yPct:50},
      {team:'home', label:'LW', xPct:22, yPct:30},
      {team:'home', label:'ST', xPct:50, yPct:24},
      {team:'home', label:'RW', xPct:78, yPct:30}
    ],
    "4-4-2": [
      {team:'home', label:'GK', xPct:50, yPct:87},
      {team:'home', label:'LB', xPct:18, yPct:68},
      {team:'home', label:'CB', xPct:40, yPct:68},
      {team:'home', label:'CB2', xPct:60, yPct:68},
      {team:'home', label:'RB', xPct:82, yPct:68},
      {team:'home', label:'LM', xPct:20, yPct:44},
      {team:'home', label:'CM', xPct:40, yPct:44},
      {team:'home', label:'CM2', xPct:60, yPct:44},
      {team:'home', label:'RM', xPct:80, yPct:44},
      {team:'home', label:'ST1', xPct:42, yPct:24},
      {team:'home', label:'ST2', xPct:58, yPct:24}
    ],
    "3-5-2": [
      {team:'home', label:'GK', xPct:50, yPct:87},
      {team:'home', label:'CB1', xPct:30, yPct:68},
      {team:'home', label:'CB2', xPct:50, yPct:68},
      {team:'home', label:'CB3', xPct:70, yPct:68},
      {team:'home', label:'LM', xPct:20, yPct:48},
      {team:'home', label:'CM1', xPct:35, yPct:48},
      {team:'home', label:'CM2', xPct:50, yPct:42},
      {team:'home', label:'CM3', xPct:65, yPct:48},
      {team:'home', label:'RM', xPct:80, yPct:48},
      {team:'home', label:'ST1', xPct:42, yPct:24},
      {team:'home', label:'ST2', xPct:58, yPct:24}
    ]
  };

  applyFormation.addEventListener('click', ()=>{
    const v = formationSelect.value;
    if(!v || !formations[v]) { alert('Pick a formation'); return; }
    // remove existing home players
    const existing = Array.from(pitch.querySelectorAll('.player')).filter(p=>p.dataset.team==='home');
    existing.forEach(n=>n.remove());
    formations[v].forEach(item=>{
      const el = document.createElement('div');
      el.className = 'player home';
      el.dataset.type = 'player';
      el.dataset.team = 'home';
      el.dataset.label = item.label;
      el.textContent = item.label;
      // place by percent
      const nx = (item.xPct/100) * pitch.clientWidth;
      const ny = (item.yPct/100) * pitch.clientHeight;
      el.style.left = (nx - 22) + 'px';
      el.style.top = (ny - 22) + 'px';
      pitch.appendChild(el);
      attachEntityEvents(el);
    });
    pushUndo({op:'apply-formation', formation:v});
    if(recording) captureFrame();
  });

  /* ------- zoom ------- */
  zoomRange.addEventListener('input', () => {
    const s = parseFloat(zoomRange.value);
    pitch.style.transform = 'scale(' + s + ')';
  });

  /* ------- save/load ------- */
  function snapshot(){
    // collect players, ball, arrows
    const entities = [];
    pitch.querySelectorAll('[data-type]').forEach(n=>{
      const r = {
        type: n.dataset.type,
        team: n.dataset.team,
        label: n.dataset.label,
        left: parseFloat(n.style.left||0),
        top: parseFloat(n.style.top||0),
        html: n.outerHTML
      };
      entities.push(r);
    });
    const arr = arrows.map(a => ({
      x1:+a.getAttribute('x1'), y1:+a.getAttribute('y1'),
      x2:+a.getAttribute('x2'), y2:+a.getAttribute('y2')
    }));
    return {entities, arrows:arr, time:Date.now()};
  }

  saveBtn.addEventListener('click', () => {
    const data = snapshot();
    localStorage.setItem('tactics-console-save', JSON.stringify(data));
    alert('Saved to local storage.');
  });

  loadLocal.addEventListener('click', () => {
    const raw = localStorage.getItem('tactics-console-save');
    if(!raw) return alert('No saved layout in this browser.');
    loadFromJSON(JSON.parse(raw));
  });

  clearLocal.addEventListener('click', ()=>{
    if(confirm('Clear saved layout from this browser?')) localStorage.removeItem('tactics-console-save');
  });

  downloadBtn.addEventListener('click', ()=>{
    const data = snapshot();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'tactics-layout.json';
    a.click(); URL.revokeObjectURL(url);
  });

  importInput.addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const obj = JSON.parse(r.result);
        loadFromJSON(obj);
      } catch(err){ alert('Invalid file'); }
    };
    r.readAsText(f);
  });

  function loadFromJSON(obj){
    // clear pitch entities and arrows
    Array.from(pitch.querySelectorAll('[data-type]')).forEach(n=>n.remove());
    Array.from(arrowLayer.querySelectorAll('line')).forEach(n=>n.remove());
    arrows = [];
    // recreate entities
    (obj.entities||[]).forEach(e=>{
      if(e.type === 'player'){
        const el = document.createElement('div');
        el.className = 'player ' + (e.team||'home');
        el.dataset.type = 'player';
        el.dataset.team = e.team||'home';
        el.dataset.label = e.label || '';
        el.textContent = el.dataset.label;
        el.style.left = (e.left||0)+'px';
        el.style.top = (e.top||0)+'px';
        pitch.appendChild(el);
        attachEntityEvents(el);
      } else if(e.type === 'ball'){
        const el = document.createElement('div');
        el.className = 'ball';
        el.dataset.type = 'ball';
        el.style.left = (e.left||0)+'px';
        el.style.top = (e.top||0)+'px';
        pitch.appendChild(el);
        attachEntityEvents(el);
      }
    });
    (obj.arrows||[]).forEach(a=>{
      const final = document.createElementNS('http://www.w3.org/2000/svg','line');
      final.setAttribute('x1',a.x1); final.setAttribute('y1',a.y1);
      final.setAttribute('x2',a.x2); final.setAttribute('y2',a.y2);
      final.setAttribute('stroke','#FFA500'); final.setAttribute('stroke-width','6');
      final.setAttribute('marker-end','url(#arrowhead)');
      arrowLayer.appendChild(final);
      arrows.push(final);
    });
    alert('Loaded layout');
  }

  /* ------- undo ------- */
  function pushUndo(op){
    undoStack.push(op);
    if(undoStack.length>80) undoStack.shift();
  }
  undoBtn.addEventListener('click', ()=>{
    const last = undoStack.pop();
    if(!last) return alert('Nothing to undo');
    if(last.op === 'add'){
      last.node.remove();
    } else if(last.op === 'remove'){
      pitch.appendChild(last.node);
      attachEntityEvents(last.node);
    } else if(last.op === 'add-arrow'){
      last.node.remove();
      arrows = arrows.filter(a=>a!==last.node);
    } else if(last.op === 'remove-arrow'){
      arrowLayer.appendChild(last.node);
      arrows.push(last.node);
    } else if(last.op === 'move'){
      // cannot fully restore older pos easily; skip
      alert('Undo move is limited — try save/load for safety');
    } else if(last.op === 'apply-formation'){
      alert('Undo formation not supported (re-load saved layout if needed)');
    }
  });

  /* ------- selected info ------- */
  function updateSelectedInfo(){
    if(!selected){ selectedInfo.textContent = 'None selected'; return; }
    if(selected instanceof SVGElement){
      selectedInfo.innerHTML = 'Arrow — coords: ' + 
        Math.round(selected.getAttribute('x1'))+','+Math.round(selected.getAttribute('y1')) +
        ' → ' + Math.round(selected.getAttribute('x2'))+','+Math.round(selected.getAttribute('y2'));
    } else {
      selectedInfo.innerHTML = 'Type: ' + selected.dataset.type + '<br> Team: ' + (selected.dataset.team||'-') + '<br> Label: ' + (selected.dataset.label||'-');
    }
  }

  /* ------- clear arrows ------- */
  clearArrowsBtn.addEventListener('click', ()=>{
    arrows.forEach(a=>a.remove());
    arrows = [];
    pushUndo({op:'clear-arrows'});
  });

  /* ------- recording frames ------- */
  startRec.addEventListener('click', ()=>{
    recording = true; recordFrames = [];
    startRec.disabled = true; stopRec.disabled = false;
    captureFrame(); // first
    alert('Recording started — move players to create frames. Click Stop when finished.');
  });
  stopRec.addEventListener('click', ()=>{
    if(!recording) return;
    recording = false; startRec.disabled = false; stopRec.disabled = true;
    if(recordFrames.length === 0) return alert('No frames recorded');
    // offer download
    const blob = new Blob([JSON.stringify(recordFrames,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'tactics-recording.json'; a.click(); URL.revokeObjectURL(url);
    alert('Recording downloaded (JSON frames). You can later implement playback from this file.');
  });

  function captureFrame(){
    const frame = {time:Date.now(), entities:[], arrows:[]};
    pitch.querySelectorAll('[data-type]').forEach(n=>{
      frame.entities.push({
        type: n.dataset.type,
        team: n.dataset.team,
        label: n.dataset.label,
        left: parseFloat(n.style.left||0),
        top: parseFloat(n.style.top||0)
      });
    });
    arrows.forEach(a=>{
      frame.arrows.push({x1:+a.getAttribute('x1'), y1:+a.getAttribute('y1'), x2:+a.getAttribute('x2'), y2:+a.getAttribute('y2')});
    });
    recordFrames.push(frame);
  }

  /* ------- exit back to index (simple link) ------- */
  exitBtn.addEventListener('click', ()=> {
    window.location.href = 'index.html';
  });

  /* ---- initial demo content ---- */
  // add default home formation
  (function seedDemo(){
    // two teams and ball
    const demo = [
      {team:'home', label:'GK', left: (pitch.clientWidth*0.5 - 22), top: (pitch.clientHeight*0.85 - 22)},
      {team:'home', label:'LB', left: (pitch.clientWidth*0.18 - 22), top: (pitch.clientHeight*0.66 - 22)},
      {team:'home', label:'CB', left: (pitch.clientWidth*0.40 - 22), top: (pitch.clientHeight*0.66 - 22)},
      {team:'home', label:'CB2', left: (pitch.clientWidth*0.60 - 22), top: (pitch.clientHeight*0.66 - 22)},
      {team:'home', label:'RB', left: (pitch.clientWidth*0.82 - 22), top: (pitch.clientHeight*0.66 - 22)},
      {team:'home', label:'ST', left: (pitch.clientWidth*0.5 - 22), top: (pitch.clientHeight*0.24 - 22)},
      {team:'away', label:'GK', left: (pitch.clientWidth*0.5 - 22), top: (pitch.clientHeight*0.12 - 22)}
    ];
    demo.forEach(d=>{
      const el = document.createElement('div');
      el.className = 'player ' + (d.team==='home'?'home':'away');
      el.dataset.type = 'player';
      el.dataset.team = d.team;
      el.dataset.label = d.label;
      el.textContent = d.label;
      el.style.left = d.left+'px'; el.style.top = d.top+'px';
      pitch.appendChild(el);
      attachEntityEvents(el);
    });
    // ball
    const b = document.createElement('div');
    b.className = 'ball'; b.dataset.type='ball';
    b.style.left = (pitch.clientWidth*0.5 - 11) + 'px';
    b.style.top = (pitch.clientHeight*0.48 - 11) + 'px';
    pitch.appendChild(b); attachEntityEvents(b);
  })();

  // helper: click on arrow to select when tool=select
  arrowLayer.addEventListener('click', e=>{
    if(e.target.tagName === 'line' && tool !== 'erase'){
      selected = e.target; updateSelectedInfo();
      e.stopPropagation();
    }
  });

  // clicking outside resets selection
  pitch.addEventListener('click', ()=> {
    // no-op handled earlier
  });

})();
</script>
</body>
</html>
